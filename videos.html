<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Likering Videos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
    
    body {
        background-color: #000;
        margin: 0;
        font-family: 'Poppins', sans-serif;
        overflow: hidden;
    }

    .tiktok-app {
        width: 100%;
        height: 100vh;
        display: flex;
        flex-direction: column;
        background-color: #000;
        position: relative;
    }

    .video-container{
        flex-grow:1;
        position:relative;
        overflow:hidden;
        background-color:#000;
        display:flex;
        justify-content:center;
        align-items:center;
        touch-action: pan-y;
    }


    .comment-item {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        position: relative;
        padding: 8px;
        border-radius: 12px;
        transition: background-color 0.3s ease;
    }

    .comment-item:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }

    .comment-message {
        background: #2c2c2c;
        padding: 12px 16px;
        border-radius: 18px;
        border-bottom-left-radius: 6px;
        word-wrap: break-word;
        word-break: break-word;
        max-width: 100%;
        position: relative;
    }

    .comment-message.editing {
        background: #3a3a3a;
        border: 2px solid var(--plan-color-principal, #fe2c55);
    }

    .comment-edit-input {
        background: transparent;
        border: none;
        color: #fff;
        font-size: 0.85rem;
        line-height: 1.4;
        width: 100%;
        resize: none;
        outline: none;
        min-height: 20px;
    }

    .comment-edit-input::placeholder {
        color: #888;
    }

    .comment-options {
        position: absolute;
        top: 8px;
        right: 8px;
        opacity: 0;
        transition: opacity 0.3s ease;
        display: flex;
        gap: 5px;
    }

    .comment-item:hover .comment-options {
        opacity: 1;
    }

    .comment-option-btn {
        background: rgba(0, 0, 0, 0.7);
        border: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        color: white;
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .comment-option-btn:hover {
        transform: scale(1.1);
    }

    .comment-option-btn.edit {
        background: #ffa500;
    }

    .comment-option-btn.delete {
        background: #ff4757;
    }

    .comment-option-btn:disabled {
        background: #666;
        cursor: not-allowed;
        opacity: 0.5;
    }

    .comment-info {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 5px;
        font-size: 0.65rem;
        opacity: 0.7;
    }

    .comment-time {
        color: #888;
    }

    .comment-edited {
        color: #ffa500;
        font-style: italic;
    }

    .edit-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        justify-content: flex-end;
    }

    .edit-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .edit-btn.save {
        background: #28a745;
        color: white;
    }

    .edit-btn.cancel {
        background: #666;
        color: white;
    }

    .edit-btn:hover {
        transform: translateY(-1px);
    }

    .edit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }





    /* Modal de eliminaci√≥n de comentario */
    .comment-delete-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .comment-delete-modal.show {
        opacity: 1;
        visibility: visible;
    }

    .comment-delete-modal .modal-container {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 16px;
        width: 90%;
        max-width: 400px;
        padding: 25px;
        text-align: center;
        color: white;
        transform: scale(0.9) translateY(20px);
        transition: transform 0.3s ease;
    }

    .comment-delete-modal.show .modal-container {
        transform: scale(1) translateY(0);
    }

    .comment-delete-modal h3 {
        margin: 0 0 15px 0;
        font-size: 1.2rem;
        color: #ff4757;
    }

    .comment-delete-modal p {
        margin: 0 0 20px 0;
        color: #ccc;
    }

    .comment-delete-modal .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
    }

    .comment-delete-modal button {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .comment-delete-modal .cancel-btn {
        background: #666;
        color: white;
    }

    .comment-delete-modal .delete-btn {
        background: #ff4757;
        color: white;
    }

    .comment-delete-modal button:hover {
        transform: translateY(-2px);
    }

    .comment-delete-modal button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .floating-menu li#logout-btn {
        border-top: 1px solid #ddd;
        margin-top: 8px;
        padding-top: 12px;
        color: #dc3545;
    }

    .floating-menu li#logout-btn:hover {
        background-color: #ffebee;
        color: #c62828;
    }

    .floating-menu li#logout-btn i {
        color: #dc3545;
    }

    .video-wrapper{
        position:absolute;
        width:100%;
        height:100%;
        color:#fff;
        transition: transform 0.45s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        cursor:pointer;
        display: flex;
        justify-content: center;
        align-items: center;
    }


    .follow-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(3px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .follow-modal-overlay.show {
        opacity: 1;
        visibility: visible;
    }

    .follow-modal-container {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 20px;
        padding: 30px;
        text-align: center;
        color: white;
        max-width: 300px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        transform: scale(0.8) translateY(30px);
        transition: transform 0.3s ease;
    }

    .follow-modal-overlay.show .follow-modal-container {
        transform: scale(1) translateY(0);
    }

    .follow-success-icon {
        font-size: 3rem;
        color: #28a745;
        margin-bottom: 15px;
        animation: successPulse 0.6s ease;
    }

    @keyframes successPulse {
        0% { transform: scale(0); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }

    .follow-modal-container h3 {
        margin: 0 0 10px 0;
        font-size: 1.4rem;
        font-weight: 600;
    }

    .follow-modal-container p {
        margin: 0;
        font-size: 1rem;
        color: #ccc;
        line-height: 1.4;
    }

    /* ==== NUEVO: ESTILOS PARA MODAL DE CONFIRMACI√ìN DE SEGUIR ==== */
    .follow-confirm-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1001;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .follow-confirm-modal-overlay.show {
        opacity: 1;
        visibility: visible;
    }

    .follow-confirm-modal-container {
        background: #1e1e1e;
        border: 1px solid #333;
        border-radius: 20px;
        padding: 30px;
        text-align: center;
        color: white;
        max-width: 320px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        transform: scale(0.9);
        transition: transform 0.3s ease;
    }

    .follow-confirm-modal-overlay.show .follow-confirm-modal-container {
        transform: scale(1);
    }

    .follow-confirm-modal-container h3 {
        margin: 0 0 10px 0;
        font-size: 1.3rem;
        font-weight: 600;
        word-break: break-word;
    }

     .follow-confirm-modal-container h3 span {
        color: #fe2c55; 
     }

    .follow-confirm-modal-container p {
        margin: 0 0 25px 0;
        font-size: 0.9rem;
        color: #ccc;
        line-height: 1.4;
    }

    /* Slider Styles */
    .slider-container {
        width: 100%;
        padding: 0;
        box-sizing: border-box;
        margin-bottom: 25px;
        user-select: none;
    }

    .slider-track {
        position: relative;
        width: 100%;
        height: 50px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .slider-thumb {
        position: absolute;
        left: 4px;
        top: 4px;
        width: 42px;
        height: 42px;
        background-color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fe2c55;
        font-size: 1.2rem;
        cursor: grab;
        z-index: 2;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .slider-thumb:active {
        cursor: grabbing;
        transform: scale(1.05);
    }

    .slider-text {
        color: #aaa;
        font-weight: 500;
        font-size: 0.9rem;
        z-index: 1;
        transition: opacity 0.2s ease-in-out;
    }

    .cancel-follow-btn {
        background: transparent;
        border: none;
        color: #888;
        font-weight: 600;
        cursor: pointer;
        padding: 8px 16px;
        transition: color 0.2s;
        font-size: 0.9rem;
    }

    .cancel-follow-btn:hover {
        color: #fff;
    }
     /* ==== FIN DE NUEVOS ESTILOS ==== */


    /* Responsive */
    @media (max-width: 480px) {
        .follow-modal-container {
            padding: 25px 20px;
            max-width: 280px;
        }
        
        .follow-success-icon {
            font-size: 2.5rem;
        }
        
        .follow-modal-container h3 {
            font-size: 1.2rem;
        }
        
        .follow-modal-container p {
            font-size: 0.9rem;
        }
    }


    .play-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80px;
        height: 80px;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
        cursor: pointer;
        z-index: 10;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
        border: 3px solid rgba(255, 255, 255, 0.3);
    }

    .play-indicator:hover {
        background: rgba(0, 0, 0, 0.8);
        transform: translate(-50%, -50%) scale(1.1);
        border-color: rgba(255, 255, 255, 0.5);
    }

    .play-indicator i {
        margin-left: 3px; /* Centrar visualmente el √≠cono de play */
    }

    /* Animaci√≥n para el indicador */
    @keyframes playPulse {
        0%, 100% {
            transform: translate(-50%, -50%) scale(1);
        }
        50% {
            transform: translate(-50%, -50%) scale(1.05);
        }
    }

    .play-indicator {
        animation: playPulse 2s infinite ease-in-out;
    }

    /* Responsive para m√≥viles */
    @media (max-width: 480px) {
        .play-indicator {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }
    }


    /* Responsive */
    @media (max-width: 480px) {
        .follow-modal-container {
            padding: 25px 20px;
            max-width: 280px;
        }
        
        .follow-success-icon {
            font-size: 2.5rem;
        }
        
        .follow-modal-container h3 {
            font-size: 1.2rem;
        }
        
        .follow-modal-container p {
            font-size: 0.9rem;
        }
    }



    .video-player{
        position:absolute;
        top:0;
        left:0;
        width:100%;
        height:100%;
        object-fit:cover;
        z-index:1;
    }
    .video-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom,rgba(0,0,0,.5) 0,rgba(0,0,0,0) 30%,rgba(0,0,0,0) 70%,rgba(0,0,0,.5) 100%);z-index:2;pointer-events:none}
    .top-left-info{position:absolute;top:40px;left:20px;right:50px;z-index:3;display:flex;flex-direction:column;gap:10px;pointer-events:none}
    .top-left-info h3,.top-left-info .description,.top-left-info .music-info{pointer-events:auto}
    .top-left-info h3{margin:0;font-size:1em;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,.7)}
    .top-left-info .description{font-size:.85em;line-height:1.4;margin:0}
    .top-left-info .music-info{display:flex;align-items:center;font-size:.8em;font-weight:600}
    .music-info i{margin-right:8px}
    .bottom-left-actions{position:absolute;bottom:20px;left:20px;z-index:4;display:flex;align-items:flex-end;color:#fff;gap:20px;pointer-events:none}
    .bottom-left-actions > div{pointer-events:auto}
    .profile-picture-container{position:relative}
    .profile-picture{width:45px;height:45px;border-radius:8px;background-size:cover;border:2px solid #fff;box-shadow:0 0 5px rgba(0,0,0,.5);cursor:pointer}
    .follow-button{position:absolute;bottom:-8px;right:-8px;width:20px;height:20px;background-color:#fe2c55;border-radius:4px;display:flex;justify-content:center;align-items:center;color:#fff;font-size:16px;line-height:20px;font-weight:700;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,.3);transition:opacity .3s ease,transform .3s ease}
    .interaction-area{display:flex;flex-direction:column;align-items:center;justify-content:center;height:45px;box-sizing:border-box}
    .interaction-area .icon{font-size:1.8em;cursor:pointer;color:#fff;transition:color .2s ease-in-out,transform .2s ease,text-shadow .2s ease;text-shadow:0 0 5px rgba(0,0,0,.5);margin-bottom:2px}
    .interaction-area .icon.liked{color:#fe2c55;transform:scale(1.1);text-shadow:0 0 12px #fe2c55}
    .interaction-area .count{font-size:.8em;font-weight:600}
    .my-profile-badge{position:absolute;right:20px;bottom:20px;z-index:51;width:45px;height:45px;border-radius:8px;cursor:pointer;overflow:hidden}
    .my-profile-picture{width:100%;height:100%;background-size:cover;border:2px solid #fff;box-shadow:0 0 5px rgba(0,0,0,.5);border-radius:8px;box-sizing:border-box;transition:filter .3s ease}
    .my-profile-badge:hover .my-profile-picture{filter:brightness(.6)}
    .my-profile-badge:hover span{opacity:1}
    .options-icon{position:absolute;top:45px;right:15px;font-size:1.5em;color:#fff;z-index:3;cursor:pointer;text-shadow:0 1px 3px rgba(0,0,0,.5)}
    .floating-menu-container,.options-menu-container,.comments-panel-container,.share-menu-container{position:absolute;top:0;left:0;width:100%;height:100%;z-index:50;opacity:0;visibility:hidden;transition:opacity .3s ease,visibility 0s .3s}
    .floating-menu-container.active,.options-menu-container.active,.comments-panel-container.active,.share-menu-container.active{opacity:1;visibility:visible;transition:opacity .3s ease}
    .floating-menu-container,.options-menu-container,.share-menu-container{background-color:rgba(0,0,0,.4)}
    .options-menu-container,.share-menu-container{z-index:60;background:transparent}
    .floating-menu,.options-menu{position:absolute;width:180px;background-color:#f0f0f0;color:#111;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.2);opacity:0;transition:transform .3s ease,opacity .3s ease}
    .floating-menu{bottom:80px;right:15px;transform:translateY(15px)}
    .options-menu{top:75px;right:15px;transform:translateY(-15px)}
    .floating-menu-container.active .floating-menu,.options-menu-container.active .options-menu{transform:translateY(0);opacity:1}
    .floating-menu::after,.options-menu::before{content:'';position:absolute;width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent}
    .floating-menu::after{bottom:-8px;right:24px;border-top:8px solid #f0f0f0}
    .options-menu::before{top:-8px;right:12px;border-bottom:8px solid #f0f0f0}
    .floating-menu ul,.options-menu ul{list-style:none;margin:0;padding:8px}
    .floating-menu li,.options-menu li{display:flex;align-items:center;padding:12px 15px;cursor:pointer;font-size:.9em;font-weight:600;border-radius:8px;transition:background-color .2s ease}
    .floating-menu li:hover,.options-menu li:hover{background-color:#ddd}
    .floating-menu li i,.options-menu li i{width:25px;margin-right:12px;text-align:center;font-size:1.1em}
    .floating-menu a{text-decoration:none;color:inherit;display:flex;align-items:center;width:100%}
    .comments-panel-container{z-index:70}
    .comments-panel{position:absolute;bottom:0;left:0;width:100%;background-color:#181818;border-top-left-radius:16px;border-top-right-radius:16px;transform:translateY(100%);display:flex;flex-direction:column;color:#fff;height:65%;transition:transform .4s ease-out}
    .comments-panel-container.active .comments-panel{transform:translateY(0)}
    .comments-header{text-align:center;padding:15px;border-bottom:1px solid #333;position:relative;flex-shrink:0}
    .comments-header h4{font-weight:600}
    .close-comments{position:absolute;top:50%;right:15px;transform:translateY(-50%);font-size:1.2rem;color:#888;cursor:pointer}
    .comments-list{flex-grow:1;overflow-y:auto;padding:15px;scrollbar-width:none;-ms-overflow-style:none}
    .comments-list::-webkit-scrollbar{display:none}
    .comment-item{display:flex;gap:12px;margin-bottom:20px}
    .comment-avatar{width:40px;height:40px;border-radius:8px;background-size:cover;flex-shrink:0}
    .comment-body{flex-grow:1}
    .comment-user{font-weight:700;font-size:.9rem;margin-bottom:4px}
    .comment-text{font-size:.85rem;line-height:1.4}
    .add-comment-area{display:flex;align-items:center;gap:10px;padding:10px 15px;border-top:1px solid #333;background-color:#181818;flex-shrink:0}
    .my-avatar-comment{width:35px;height:35px;border-radius:8px;background-size:cover;background-position:center;flex-shrink:0}
    .add-comment-area input{flex-grow:1;padding:12px 15px;border:none;background-color:#2c2c2c;border-radius:20px;color:#fff;outline:none}
    .add-comment-area input::placeholder{color:#888}
    .add-comment-area .send-comment-btn{background:none;border:none;color:#fff;font-size:1.3rem;cursor:pointer;padding:5px}
    .share-panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px}
    .share-panel-header h4{margin:0;font-weight:600;font-size:1.1em}
    .share-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:20px}
    .share-option{display:flex;flex-direction:column;align-items:center;gap:10px;cursor:pointer}
    .share-icon{width:65px;height:65px;border-radius:12px;display:flex;justify-content:center;align-items:center;font-size:2em;color:#fff;box-shadow:0 4px 12px rgba(0,0,0,.3);transition:transform .2s ease-out,box-shadow .2s ease-out}
    .share-icon:hover{transform:translateY(-5px) scale(1.05);box-shadow:0 8px 20px rgba(0,0,0,.4)}
    .share-icon.whatsapp{background:linear-gradient(135deg,#25d366,#128c7e)}
    .share-icon.instagram{background:radial-gradient(circle at 30% 107%,#fdf497 0,#fdf497 5%,#fd5949 45%,#d6249f 60%,#285aeb 90%)}
    .share-icon.copy-link{background:linear-gradient(135deg,#6c757d,#343a40)}
    .share-option span{font-size:.8em;font-weight:500;color:#ccc}
    .download-progress-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);z-index:999;display:flex;justify-content:center;align-items:center;opacity:0;visibility:hidden;transition:opacity .3s,visibility 0s .3s}
    .download-progress-overlay.active{opacity:1;visibility:visible;transition:opacity .3s}
    .download-progress-box{background-color:#282828;color:#fff;padding:20px 30px;border-radius:12px;text-align:center;font-weight:600}
    .download-progress-box i{font-size:1.5em;margin-right:10px}
    .loading-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: white;
        z-index: 10;
    }
    .loading-spinner img {
        width: 80px;
        height: 80px;
        margin-bottom: 10px;
    }
    .loading-spinner p {
        font-size: 1.2em;
        font-weight: 600;
    }
    .volume-indicator{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:3em;color:rgba(255,255,255,.8);background-color:rgba(0,0,0,.4);padding:15px;border-radius:50%;z-index:5;opacity:0;transition:opacity .3s ease-out;pointer-events:auto;}
    .volume-indicator.show{opacity:1}
    
    /* Alinea tu avatar al mismo nivel que el del streamer */
    .my-profile-badge {
      bottom: 22px !important;
    }
/* REEMPLAZA ESTE BLOQUE COMPLETO EN TU CSS */
    @media (max-width: 480px) {
        .bottom-left-actions {
            left: 15px;
            /* MODIFICADO: Aumentamos el valor para subir los iconos */
            bottom: 20px; 
            gap: 15px;
        }


        .top-left-info {
            top: 10px;
            left: 15px;
        }
        .my-profile-badge {
            /* MODIFICADO: Aumentamos el valor para que se alinee con los otros iconos */
            bottom: 95px; 
            right: 10px;
        }
        .options-icon {
            top: 10px;
        }
    }
</style>
</head>
<body>
    <div class="tiktok-app">
        <div class="video-container">
            <div class="loading-spinner" id="loading-spinner">
                <img src="https://i.postimg.cc/PJm3mRTH/image.png" alt="Likering Logo">
                <p>Cargando...</p>
            </div>
        </div>


        <div class="follow-modal-overlay" id="follow-modal">
            <div class="follow-modal-container">
                <div class="follow-modal-content">
                    <div class="follow-success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3>¬°Listo!</h3>
                    <p id="follow-message">Ahora sigues a este canal</p>
                </div>
            </div>
        </div>

        <div class="follow-confirm-modal-overlay" id="follow-confirm-modal">
            <div class="follow-confirm-modal-container">
                <h3>¬øQuieres seguir a <span id="follow-confirm-username"></span>?</h3>
                <p>Para confirmar, desliza el c√≠rculo hacia la derecha.</p>
                <div class="slider-container" id="follow-slider-container">
                    <div class="slider-track">
                        <div class="slider-thumb" id="follow-slider-thumb">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <span class="slider-text">Desliza para seguir</span>
                    </div>
                </div>
                <button class="cancel-follow-btn" id="cancel-follow-btn">Cancelar</button>
            </div>
        </div>
        
        <div class="my-profile-badge"><div class="my-profile-picture"></div><span>Yo</span></div>
        <div class="floating-menu-container"><div class="floating-menu"><ul><li><a href="billetera.html"><i class="fas fa-wallet"></i><span>Billetera</span></a></li><li><a href="mensajes.html"><i class="far fa-comments"></i><span>Mensajes</span></a></li><li><a href="perfil.html"><i class="fas fa-user-circle"></i><span>Perfil</span></a></li><li id="logout-btn"><i class="fas fa-sign-out-alt"></i><span>Cerrar Sesi√≥n</span></li></ul></div></div>
        <div class="options-menu-container"><div class="options-menu"><ul><li id="share-btn"><i class="fas fa-share-square"></i><span>Compartir</span></li><li id="download-btn"><i class="fas fa-download"></i><span>Descargar</span></li><li id="report-video-btn"><i class="fas fa-flag"></i><span>Reportar</span></li></ul></div></div>
        <div class="comments-panel-container"><div class="comments-panel"><div class="comments-header"><h4 id="comments-count">0 comentarios</h4><i class="fas fa-times close-comments"></i></div><div class="comments-list" id="comments-list"></div><div class="add-comment-area"><div class="my-avatar-comment"></div><input type="text" id="comment-input" placeholder="A√±adir un comentario..."><button class="send-comment-btn" id="send-comment-btn"><i class="fas fa-arrow-right"></i></button></div></div></div>
        <div class="share-menu-container"><div class="share-panel"><div class="share-panel-header"><h4>Compartir en</h4><i class="fas fa-times close-share"></i></div><div class="share-grid"><div class="share-option"><div class="share-icon whatsapp"><i class="fab fa-whatsapp"></i></div><span>WhatsApp</span></div><div class="share-option"><div class="share-icon instagram"><i class="fab fa-instagram"></i></div><span>Instagram</span></div><div class="share-option"><div class="share-icon copy-link"><i class="fas fa-link"></i></div><span>Copiar enlace</span></div></div></div></div>
        <div class="download-progress-overlay"><div class="download-progress-box"><span id="download-status"></span></div></div>
        
        <!-- Modal de Reportar Video -->
        <div class="follow-modal-overlay" id="report-video-modal">
            <div class="follow-modal-container">
                <h3 style="margin-bottom: 20px; color: #ef4444;"><i class="fas fa-flag"></i> Reportar Video</h3>
                <p style="margin-bottom: 15px; color: #ccc;">Est√°s reportando un video de <strong id="report-video-username"></strong></p>
                <div style="margin-bottom: 15px; text-align: left;">
                    <label style="display: block; margin-bottom: 8px; color: #fff; font-weight: 600;">Motivo del reporte *</label>
                    <select id="report-video-reason" style="width: 100%; padding: 10px; background: #2c2c2c; border: 1px solid #444; border-radius: 8px; color: #fff; font-size: 0.9rem;">
                        <option value="">Selecciona un motivo</option>
                        <option value="Contenido inapropiado">Contenido inapropiado</option>
                        <option value="Spam o enga√±oso">Spam o enga√±oso</option>
                        <option value="Violencia">Violencia</option>
                        <option value="Derechos de autor">Derechos de autor</option>
                        <option value="Desinformaci√≥n">Desinformaci√≥n</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px; text-align: left;">
                    <label style="display: block; margin-bottom: 8px; color: #fff; font-weight: 600;">Descripci√≥n (opcional)</label>
                    <textarea id="report-video-description" placeholder="Proporciona m√°s detalles..." style="width: 100%; min-height: 80px; padding: 10px; background: #2c2c2c; border: 1px solid #444; border-radius: 8px; color: #fff; font-size: 0.9rem; resize: vertical; font-family: 'Poppins', sans-serif;"></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="cancel-report-video-btn" class="cancel-follow-btn" style="flex: 1;">Cancelar</button>
                    <button id="submit-report-video-btn" style="flex: 1; padding: 10px; background: #ef4444; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Enviar</button>
                </div>
            </div>
        </div>
    </div>

<script src="config.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const videoContainer = document.querySelector('.video-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const commentsList = document.getElementById('comments-list');
        const commentsCountHeader = document.getElementById('comments-count');

        let allVideosMasterList = [];
        let videosToPlayQueue = [];
        let loadedVideoElements = [];
        let currentVideoIndex = 0;
        let loggedInUser = null;

        // ‚Äì‚Äì‚Äì‚Äì‚Äì Selecci√≥n de elementos del DOM ‚Äì‚Äì‚Äì‚Äì‚Äì
        const commentsPanelContainer = document.querySelector('.comments-panel-container'); 
        const closeCommentsBtn       = document.querySelector('.close-comments');         // :contentReference[oaicite:4]{index=3}
        const commentInput           = document.querySelector('.add-comment-area input');
        const sendCommentBtn         = document.querySelector('.add-comment-area .send-comment-btn');

        // ==== NUEVO: Variables para el modal de confirmaci√≥n ====
        let targetUserToFollow = null;
        const followConfirmModal = document.getElementById('follow-confirm-modal');
        const sliderThumb = document.getElementById('follow-slider-thumb');
        const sliderContainer = document.getElementById('follow-slider-container');
        const cancelFollowBtn = document.getElementById('cancel-follow-btn');
        const followConfirmUsernameSpan = document.getElementById('follow-confirm-username');
        let isSliding = false;
        let startX = 0;
        let initialThumbX = 0;


        // ‚Äì‚Äì‚Äì‚Äì‚Äì Cerrar panel de comentarios ‚Äì‚Äì‚Äì‚Äì‚Äì
        closeCommentsBtn.addEventListener('click', () => {
          commentsPanelContainer.classList.remove('active');
        });

        // ‚Äì‚Äì‚Äì‚Äì‚Äì Enviar comentario ‚Äì‚Äì‚Äì‚Äì‚Äì
        sendCommentBtn.addEventListener('click', postComment);
        commentInput.addEventListener('keypress', e => {
          if (e.key === 'Enter') postComment();
        });


        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        async function fetchAllVideoMetadata() {
    if (!loggedInUser) {
        console.error("Usuario no logueado.");
        return [];
    }
    try {
        const result = await API.getAllVideos(loggedInUser.username);
        
        if (!result.success) {
            throw new Error(result.message || 'Error desconocido del backend.');
        }
        
        return result.data.map(video => {
            // Convertir expl√≠citamente is_following_user a booleano
            // El backend puede devolver true, false, null, o undefined
            const followingValue = video.is_following_user;
            let isFollowing = false;
            
            // Verificar expl√≠citamente todos los casos
            if (followingValue === true) {
                isFollowing = true;
            } else if (followingValue === 'true' || followingValue === 'True' || followingValue === 'TRUE') {
                isFollowing = true;
            } else if (followingValue === 1 || followingValue === '1') {
                isFollowing = true;
            } else if (followingValue === false || followingValue === 'false' || followingValue === null || followingValue === undefined || followingValue === 0 || followingValue === '0') {
                isFollowing = false;
            } else {
                // Para cualquier otro valor, intentar convertir a booleano
                isFollowing = Boolean(followingValue);
            }
            
            // Verificar localStorage como fuente de verdad principal
            const videoUsername = video.user ? video.user.replace('@', '') : '';
            const isFollowingInStorage = isUserFollowed(videoUsername);
            
            // Usar localStorage si est√° disponible, sino usar el valor del backend
            const finalIsFollowing = isFollowingInStorage || isFollowing;
            
            // Debug log para verificar
            if (loggedInUser && video.user && video.user !== `@${loggedInUser.username}`) {
                console.log(`[FETCH] Video @${video.user.substring(1)}: backend=${isFollowing}, localStorage=${isFollowingInStorage}, final=${finalIsFollowing}`);
            }
            
            // Verificar localStorage para likes tambi√©n
            const videoIdForLike = video.video_id || video.videoId;
            const isLikedInStorage = isVideoLiked(videoIdForLike);
            // El backend devuelve isLikedByCurrentUser (camelCase), no is_liked_by_current_user
            const isLikedFromBackend = Boolean(video.isLikedByCurrentUser || video.is_liked_by_current_user);
            // Priorizar backend sobre localStorage (el backend es la fuente de verdad)
            const finalIsLiked = isLikedFromBackend || isLikedInStorage;
            
            // Si el backend dice que est√° liked pero no est√° en localStorage, agregarlo
            if (isLikedFromBackend && !isLikedInStorage) {
                saveLikedVideo(videoIdForLike);
            }
            
            return {
                ...video,
                visualizaciones: parseInt(video.visualizaciones) || 0,
                videoId: videoIdForLike,
                profileImg: video.profile_img || video.profileImg,
                isLikedByCurrentUser: finalIsLiked, // Usar el valor combinado
                isFollowingUser: finalIsFollowing // Usar el valor combinado
            };
        });
    } catch (error) {
        console.error("Error al cargar metadatos de videos:", error);
        if (loadingSpinner) {
            loadingSpinner.innerHTML = `<img src="https://i.postimg.cc/PJm3mRTH/image.png" alt="Likering Logo"><p>Error al cargar videos.</p>`;
        }
        return [];
    }
}

        async function loadComments(videoId) {
    try {
        const result = await API.getComments(videoId);
        
        if (result.success) {
            displayComments(result.data);
        } else { 
            throw new Error(result.message); 
        }
    } catch (error) {
        commentsList.innerHTML = `<p style="text-align:center;color:red;">${error.message}</p>`;
    }
}


        function displayComments(comments) {
            commentsList.innerHTML = '';
            const count = comments.length;
            commentsCountHeader.textContent = `${count} comentario${count !== 1 ? 's' : ''}`;
            
            // Actualizar el contador en el video tambi√©n
            const currentVideoData = loadedVideoElements[currentVideoIndex]?.videoData;
            if (currentVideoData) {
                currentVideoData.comments = count;
                const commentCountSpan = loadedVideoElements[currentVideoIndex]
                    ?.querySelector('.bottom-left-actions .interaction-area:nth-child(3) .count');
                if (commentCountSpan) {
                    commentCountSpan.textContent = count;
                }
            }

            if (comments.length === 0) {
                commentsList.innerHTML = '<p style="text-align:center;color:#888;">S√© el primero en comentar.</p>';
                return;
            }

            comments.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            comments.forEach(comment => {
                const commentItem = document.createElement('div');
                commentItem.className = 'comment-item';
                commentItem.dataset.commentId = comment.commentId || '';

                const timeAgo = getTimeAgo(new Date(comment.timestamp));
                const isMyComment = loggedInUser && comment.username === loggedInUser.username;
                const canEdit = isMyComment && isWithinEditTime(new Date(comment.timestamp));
                const editedBadge = comment.edited ? '<span style="color:#888;font-size:0.85em;margin-left:5px;">(editado)</span>' : '';

                commentItem.innerHTML = `
                    <div class="comment-avatar" style="background-image: url('${comment.imageUrl || ''}')"></div>
                    <div class="comment-body">
                        <div class="comment-user">${comment.username}${editedBadge}</div>
                        <div class="comment-message" data-original-text="${comment.commentText.replace(/"/g, '&quot;')}">
                            <span class="comment-text">${comment.commentText}</span>
                        </div>
                        <div class="comment-info">
                            <span class="comment-time">${timeAgo}</span>
                            ${isMyComment ? `
                                <div class="comment-options">
                                    ${canEdit ? `<button class="edit-comment-btn" onclick="editComment('${comment.commentId}')" title="Editar">‚úèÔ∏è</button>` : ''}
                                    <button class="delete-comment-btn" onclick="deleteComment('${comment.commentId}')" title="Eliminar">üóëÔ∏è</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                commentsList.appendChild(commentItem);
            });
        }

        function isWithinEditTime(timestamp) {
            const now = new Date();
            const diffMinutes = (now - timestamp) / (1000 * 60);
            return diffMinutes <= 5;
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMinutes < 1) return 'ahora';
            if (diffMinutes < 60) return `${diffMinutes}min`;
            if (diffHours < 24) return `${diffHours}h`;
            return `${diffDays}d`;
        }

        window.editComment = function(commentId) {
          const commentItem    = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
          if (!commentItem) return;
          const commentMessage = commentItem.querySelector('.comment-message');
          const commentText    = commentMessage.querySelector('.comment-text');
          const originalText   = commentMessage.dataset.originalText || commentText.textContent;
          const editInput = document.createElement('textarea');
          editInput.className    = 'comment-edit-input';
          editInput.value        = originalText;
          editInput.placeholder  = 'Edita tu comentario‚Ä¶';
          editInput.style.width  = '100%';
          editInput.style.boxSizing = 'border-box';
          const editActions = document.createElement('div');
          editActions.className = 'edit-actions';
          editActions.innerHTML = `
            <button class="edit-btn cancel" onclick="cancelEdit('${commentId}')">Cancelar</button>
            <button class="edit-btn save"   onclick="saveEdit('${commentId}')">Guardar</button>
          `;
          commentText.style.display = 'none';
          const opts = commentMessage.querySelector('.comment-options');
          if (opts) opts.style.display = 'none';
          commentMessage.classList.add('editing');
          commentMessage.append(editInput, editActions);
          editInput.focus();
          editInput.select();
        }

        window.cancelEdit = function(commentId) {
            const commentItem = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
            if (!commentItem) return;
            const commentMessage = commentItem.querySelector('.comment-message');
            const commentText = commentMessage.querySelector('.comment-text');
            const editInput = commentMessage.querySelector('.comment-edit-input');
            const editActions = commentMessage.querySelector('.edit-actions');
            if (editInput) editInput.remove();
            if (editActions) editActions.remove();
            if (commentText) commentText.style.display = 'block';
            const options = commentMessage.querySelector('.comment-options');
            if (options) options.style.display = 'flex';
            commentMessage.classList.remove('editing');
        }

        window.saveEdit = async function(commentId) {
    const commentItem = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
    if (!commentItem) return;
    const commentMessage = commentItem.querySelector('.comment-message');
    const editInput = commentMessage.querySelector('.comment-edit-input');
    if (!editInput) return;
    const newText = editInput.value.trim();
    
    if (!newText || !commentId) {
        alert('El comentario no puede estar vac√≠o.');
        return;
    }
    
    const saveBtn = commentMessage.querySelector('.edit-btn.save');
    const cancelBtn = commentMessage.querySelector('.edit-btn.cancel');
    saveBtn.disabled = true;
    cancelBtn.disabled = true;
    saveBtn.textContent = 'Guardando...';
    
    try {
        const result = await API.editComment(commentId, newText, loggedInUser.username);
        
        if (result.success) {
            commentMessage.dataset.originalText = newText;
            commentMessage.querySelector('.comment-text').textContent = newText;
            cancelEdit(commentId);
            const commentInfo = commentItem.querySelector('.comment-info');
            if (!commentInfo.querySelector('.comment-edited')) {
                commentInfo.innerHTML += ' <span class="comment-edited">‚Ä¢ editado</span>';
            }
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        alert(`Error al editar comentario: ${error.message}`);
    } finally {
        saveBtn.disabled = false;
        cancelBtn.disabled = false;
        saveBtn.textContent = 'Guardar';
    }
}

        let currentCommentId = null;

        window.deleteComment = function(commentId) {
            currentCommentId = commentId;
            showDeleteModal(commentId);
        }

        function showDeleteModal(commentId) {
          currentCommentId = commentId;
          let modal = document.getElementById('comment-delete-modal');
          if (!modal) {
                modal = document.createElement('div');
                modal.id = 'comment-delete-modal';
                modal.className = 'comment-delete-modal';
                modal.innerHTML = `
                    <div class="modal-container">
                        <h3><i class="fas fa-exclamation-triangle"></i> Eliminar comentario</h3>
                        <p>¬øEst√°s seguro de que quieres eliminar este comentario?</p>
                        <div class="modal-actions">
                            <button class="cancel-btn" onclick="hideDeleteModal()">Cancelar</button>
                            <button class="delete-btn" onclick="confirmDeleteComment()">Eliminar</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
          modal.classList.add('show');
        }

        function hideDeleteModal() {
            const modal = document.getElementById('comment-delete-modal');
            if (modal) modal.classList.remove('show');
            currentCommentId = null;
        }

        async function confirmDeleteComment() {
    if (!currentCommentId) return;
    
    const modal = document.getElementById('comment-delete-modal');
    const deleteBtn = modal.querySelector('.delete-btn');
    const cancelBtn = modal.querySelector('.cancel-btn');
    deleteBtn.disabled = true;
    cancelBtn.disabled = true;
    deleteBtn.textContent = 'Eliminando...';
    
    try {
        const result = await API.deleteComment(currentCommentId, loggedInUser.username);
        
        if (result.success) {
            hideDeleteModal();
            const currentVideoData = loadedVideoElements[currentVideoIndex]?.videoData;
            if (currentVideoData?.videoId) {
                loadComments(currentVideoData.videoId);
                currentVideoData.comments = Math.max(0, (currentVideoData.comments || 1) - 1);
                const commentCountSpan = loadedVideoElements[currentVideoIndex]
                    .querySelector('.bottom-left-actions .interaction-area:nth-child(3) .count');
                if (commentCountSpan) commentCountSpan.textContent = currentVideoData.comments;
            }
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        alert(`Error al eliminar comentario: ${error.message}`);
    } finally {
        deleteBtn.disabled = false;
        cancelBtn.disabled = false;
        deleteBtn.textContent = 'Eliminar';
    }
}


        function saveCurrentVideoState() {
            if (loadedVideoElements[currentVideoIndex]?.videoData?.videoId) {
                localStorage.setItem('currentVideoId', loadedVideoElements[currentVideoIndex].videoData.videoId);
                localStorage.setItem('currentVideoIndex', currentVideoIndex.toString());
            }
        }

        async function restoreVideoState() {
            const savedVideoId = localStorage.getItem('currentVideoId');
            if (savedVideoId && allVideosMasterList.length > 0) {
                const videoIndex = allVideosMasterList.findIndex(video => video.videoId === savedVideoId);
                if (videoIndex !== -1) {
                    const savedVideo = allVideosMasterList[videoIndex];
                    videosToPlayQueue = [savedVideo, ...allVideosMasterList.filter(v => v.videoId !== savedVideoId)];
                    console.log(`üîÑ Restaurando video: ${savedVideo.videoId}`);
                }
            }
        }

        async function postComment() {
    const commentText = commentInput.value.trim();
    if (!commentText || !loggedInUser) return;
    
    const currentVideoData = loadedVideoElements[currentVideoIndex]?.videoData;
    if (!currentVideoData || !currentVideoData.videoId) return;
    
    sendCommentBtn.disabled = true;
    sendCommentBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    try {
        const result = await API.addComment(
            currentVideoData.videoId, 
            loggedInUser.username, 
            commentText
        );
        
        if (result.success) {
            commentInput.value = '';
            // No incrementar manualmente, el backend ya lo hace
            // Recargar comentarios para obtener el contador actualizado
            await loadComments(currentVideoData.videoId);
            // Actualizar contador desde la respuesta del servidor o recargar el video
            const commentCountSpan = loadedVideoElements[currentVideoIndex]
                .querySelector('.bottom-left-actions .interaction-area:nth-child(3) .count');
            if (commentCountSpan) {
                // El contador se actualiza autom√°ticamente cuando se recargan los comentarios
                // O podemos obtenerlo del header de comentarios
                const commentsHeader = document.getElementById('comments-count');
                if (commentsHeader) {
                    const count = parseInt(commentsHeader.textContent.match(/\d+/)?.[0] || '0');
                    commentCountSpan.textContent = count;
                    currentVideoData.comments = count;
                }
            }
        } else { 
            throw new Error(result.message); 
        }
    } catch (error) {
        alert(`Error al enviar comentario: ${error.message}`);
    } finally {
        sendCommentBtn.disabled = false;
        sendCommentBtn.innerHTML = '<i class="fas fa-arrow-right"></i>';
    }
}


       async function handleLikeClick(likeArea, videoId) {
    const iconDiv = likeArea.querySelector('.icon');
    const countSpan = likeArea.querySelector('.count');
    
    // Si ya tiene like, no hacer nada
    if (iconDiv.classList.contains('liked')) {
        return;
    }
    
    let currentLikes = parseInt(countSpan.textContent) || 0;
    
    // Agregar like visualmente
    iconDiv.classList.add('liked');
    countSpan.textContent = currentLikes + 1;
    saveLikedVideo(videoId);
    
    try {
        const result = await API.likeVideo(videoId, loggedInUser.username);
        
        if (result.success) {
            // Actualizar contador con el valor del servidor
            if (result.likes !== undefined) {
                countSpan.textContent = result.likes;
            }
        } else {
            // Revertir si falla
            iconDiv.classList.remove('liked');
            countSpan.textContent = currentLikes;
            removeLikedVideo(videoId);
        }
    } catch (error) {
        console.error("Error al registrar el like:", error);
        // Revertir si falla
        iconDiv.classList.remove('liked');
        countSpan.textContent = currentLikes;
        removeLikedVideo(videoId);
    }
}

       async function recordView(videoId, username) {
    const currentWrapper = loadedVideoElements[currentVideoIndex];
    if (currentWrapper.videoData.user === `@${username}`) {
        console.log("Vista propia, no contabilizada");
        return;
    }
    
    try {
        const result = await API.recordView(videoId, username);
        
        if (result.success && result.newViewCount !== undefined) {
            const wrapper = loadedVideoElements[currentVideoIndex];
            if (wrapper.videoData.videoId === videoId) {
                const viewsCountSpan = wrapper.querySelector('.interaction-area:nth-child(4) .count');
                if (viewsCountSpan) {
                    viewsCountSpan.textContent = result.newViewCount;
                    wrapper.videoData.visualizaciones = result.newViewCount;
                }
            }
        }
    } catch (error) {
        console.error("Error al registrar visualizaci√≥n:", error);
    }
}



        function replenishVideoQueue() {
            console.log("Cola de reproducci√≥n vac√≠a. Rellenando y re-barajando...");
            // Asegurar que allVideosMasterList est√© actualizado antes de rellenar
            videosToPlayQueue = [...allVideosMasterList];
            shuffleArray(videosToPlayQueue);
            const currentVideo = loadedVideoElements[currentVideoIndex];
            if (!currentVideo) return;
            const currentVidId = currentVideo.videoData.videoId;
            const prevVideo = loadedVideoElements[currentVideoIndex - 1];
            const prevVidId = prevVideo ? prevVideo.videoData.videoId : null;
            if (videosToPlayQueue.length > 1 && (videosToPlayQueue[0].videoId === currentVidId || videosToPlayQueue[0].videoId === prevVidId)) {
                videosToPlayQueue.push(videosToPlayQueue.shift());
            }
        }

         function createVideoElement(videoData) {
            const videoWrapper = document.createElement('div');
            videoWrapper.className = 'video-wrapper';
            videoWrapper.videoData = videoData;
            videoWrapper.userInteracted = false;
            
            const videoPlayer = document.createElement('video');
            videoPlayer.className = 'video-player';
            videoPlayer.src = videoData.videoUrl;
            videoPlayer.poster = videoData.thumbnailUrl;
            videoPlayer.loop = true;
            videoPlayer.playsInline = true;
            videoPlayer.muted = false;
            videoPlayer.preload = 'auto';
            videoPlayer.viewCounted = false;
            
            videoPlayer.addEventListener('timeupdate', () => {
                if (!loggedInUser || videoPlayer.viewCounted || isNaN(videoPlayer.duration) || loadedVideoElements[currentVideoIndex]?.querySelector('video') !== videoPlayer) {
                    return;
                }
                const percentageWatched = (videoPlayer.currentTime / videoPlayer.duration) * 100;
                if (percentageWatched > 70) {
                    recordView(videoData.videoId, loggedInUser.username);
                    videoPlayer.viewCounted = true;
                }
            });
            
            const videoOverlay = document.createElement('div');
            videoOverlay.className = 'video-overlay';
            
            const topLeftInfo = document.createElement('div');
            topLeftInfo.className = 'top-left-info';
            topLeftInfo.innerHTML = `<h3>${videoData.user}</h3><p class="description">${videoData.description}</p><div class="music-info"><i class="fas fa-music"></i><span>${videoData.music}</span></div>`;
            
            const bottomLeftActions = document.createElement('div');
            bottomLeftActions.className = 'bottom-left-actions';
            
            const profileContainer = document.createElement('div');
            profileContainer.className = 'profile-picture-container';
            
            const profilePicture = document.createElement('div');
            profilePicture.className = 'profile-picture';
            profilePicture.style.backgroundImage = `url('${videoData.profileImg}')`;

            const followButton = document.createElement('div');
            followButton.className = 'follow-button';
            followButton.textContent = '+';
            followButton.dataset.targetUser = videoData.user.substring(1); // Guardar el usuario objetivo
            
            // Verificar si es el propio video - normalizar ambos valores
            const videoUsername = videoData.user ? videoData.user.replace('@', '') : '';
            const loggedInUsername = loggedInUser ? loggedInUser.username : '';
            const isMyVideo = loggedInUser && videoUsername === loggedInUsername;
            
            // Verificar si ya sigue al usuario - PRIMERO verificar backend (fuente de verdad), luego localStorage
            const isFollowingValue = videoData.isFollowingUser;
            const isFollowingFromBackend = isFollowingValue === true || 
                                          isFollowingValue === 'true' ||
                                          String(isFollowingValue).toLowerCase() === 'true' ||
                                          Boolean(isFollowingValue) === true;
            const isFollowingInStorage = isUserFollowed(videoUsername);
            
            // Priorizar backend sobre localStorage (backend es fuente de verdad)
            const isAlreadyFollowing = isFollowingFromBackend || isFollowingInStorage;
            
            // Sincronizar localStorage con backend
            if (isFollowingFromBackend && !isFollowingInStorage) {
                saveFollowedUser(videoUsername);
            } else if (!isFollowingFromBackend && isFollowingInStorage) {
                // Si el backend dice que no se sigue pero localStorage dice que s√≠, usar backend
                removeFollowedUser(videoUsername);
            }

            // Debug: solo para usuarios que no son el propio
            if (loggedInUser && !isMyVideo) {
                const targetUsername = videoData.user.substring(1);
                console.log(`[DEBUG] Video de @${targetUsername}: localStorage=${isFollowingInStorage}, backend=${isFollowingValue}, final=${isAlreadyFollowing}, isMyVideo=${isMyVideo}`);
            }

            if (isMyVideo || isAlreadyFollowing) {
                // No agregar el bot√≥n si ya lo sigue o es su propio video
                profileContainer.append(profilePicture);
                videoData.followButtonElement = null;
                // Asegurar que isFollowingUser est√© en true si ya se sigue
                if (isAlreadyFollowing && !isMyVideo) {
                    videoData.isFollowingUser = true;
                    // Asegurar que tambi√©n est√© en localStorage
                    if (!isFollowingInStorage) {
                        saveFollowedUser(videoUsername);
                    }
                }
            } else {
                // Agregar el bot√≥n y el event listener
                followButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    if (!loggedInUser) {
                        alert("Debes iniciar sesi√≥n para seguir canales.");
                        return;
                    }
                    const targetUser = videoData.user.substring(1);
                    showFollowConfirmModal(targetUser); // Llama al nuevo modal
                });
                profileContainer.append(profilePicture, followButton);
                // Guardar referencia al bot√≥n en el videoData para acceso r√°pido
                videoData.followButtonElement = followButton;
                // Asegurar que isFollowingUser est√© en false si no se sigue
                videoData.isFollowingUser = false;
            }

            const likeArea = document.createElement('div');
            likeArea.className = 'interaction-area';
            likeArea.innerHTML = `<div class="icon"><i class="fas fa-heart"></i></div><span class="count">${videoData.likes}</span>`;
            
            // Verificar backend PRIMERO (fuente de verdad), luego localStorage
            const isLikedFromBackend = Boolean(videoData.isLikedByCurrentUser);
            const isLikedInStorage = isVideoLiked(videoData.videoId);
            const isLiked = isLikedFromBackend || isLikedInStorage;
            
            if (isLiked) {
                likeArea.querySelector('.icon').classList.add('liked');
                // Sincronizar localStorage con el backend
                if (isLikedFromBackend && !isLikedInStorage) {
                    saveLikedVideo(videoData.videoId);
                }
            }
            likeArea.addEventListener('click', (e) => {
                e.stopPropagation();
                if (videoData.user === `@${loggedInUser.username}`) {
                    alert("No puedes dar like a tus propios videos.");
                    return;
                }
                if (videoData.videoId && loggedInUser) {
                    handleLikeClick(likeArea, videoData.videoId);
                } else {
                    alert("Debes iniciar sesi√≥n para dar like.");
                }
            });
            
            const commentArea = document.createElement('div');
            commentArea.className = 'interaction-area';
            commentArea.innerHTML = `<div class="icon"><i class="far fa-comments"></i></div><span class="count">${videoData.comments}</span>`;
            if (videoData.videoId) {
                commentArea.addEventListener('click', (e) => {
                    e.stopPropagation();
                    loadComments(videoData.videoId);
                    commentsPanelContainer.classList.add('active');
                });
            }
            
            const viewsArea = document.createElement('div');
            viewsArea.className = 'interaction-area';
            viewsArea.innerHTML = `<div class="icon"><i class="fas fa-chart-bar"></i></div><span class="count">${videoData.visualizaciones}</span>`;
            
            bottomLeftActions.append(profileContainer, likeArea, commentArea, viewsArea);
            
            const optionsIcon = document.createElement('div');
            optionsIcon.className = 'options-icon';
            optionsIcon.innerHTML = `<i class="fas fa-ellipsis-h"></i>`;
            
            const volumeIndicator = document.createElement('div');
            volumeIndicator.className = 'volume-indicator';
            volumeIndicator.innerHTML = videoPlayer.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
            
            videoWrapper.addEventListener('click', (e) => {
                e.stopPropagation();
                if (videoPlayer.paused) {
                    videoPlayer.play();
                    hidePlayIndicator(videoWrapper);
                } else {
                    videoPlayer.pause();
                    showPlayIndicator(videoWrapper);
                }
            });

            volumeIndicator.addEventListener('click', (e) => {
                e.stopPropagation();
                videoPlayer.muted = !videoPlayer.muted;
                volumeIndicator.innerHTML = videoPlayer.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
                volumeIndicator.classList.add('show');
                setTimeout(() => volumeIndicator.classList.remove('show'), 800);
            });
            
            profilePicture.addEventListener('click', (e) => {
                e.stopPropagation();
                window.location.href = `streamer.html?user=${videoData.user.substring(1)}`;
            });
            
            optionsIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelector('.options-menu-container').classList.add('active');
            });
            
            videoWrapper.append(videoPlayer, videoOverlay, topLeftInfo, bottomLeftActions, optionsIcon, volumeIndicator);
            return videoWrapper;
        }


        function updateVideoState() {
            loadedVideoElements.forEach((wrapper, index) => {
                const video = wrapper.querySelector('video');
                const audio = wrapper.querySelector('audio');
                wrapper.style.transform = `translateY(${(index - currentVideoIndex) * 100}%)`;
                
                if (!video.src) {
                    video.src = wrapper.videoData.videoUrl;
                }
                
                if (index === currentVideoIndex) {
                    if (audio) {
                        audio.currentTime = 0;
                        audio.muted = false;
                        audio.play().catch(e => console.log("Fallo al reproducir audio:", e));
                    }
                    video.play().catch(e => {
                        console.log("Autoplay bloqueado, requiere interacci√≥n del usuario:", e);
                        showPlayIndicator(wrapper);
                    });
                } else {
                    video.pause();
                    video.currentTime = 0;
                    video.viewCounted = false;
                    if(audio) {
                        audio.pause();
                        audio.currentTime = 0;
                    }
                    hidePlayIndicator(wrapper);
                }
            });
        }


        function showPlayIndicator(wrapper) {
            hidePlayIndicator(wrapper);
            const playIndicator = document.createElement('div');
            playIndicator.className = 'play-indicator';
            playIndicator.innerHTML = '<i class="fas fa-play"></i>';
            playIndicator.addEventListener('click', (e) => {
                e.stopPropagation();
                const video = wrapper.querySelector('video');
                video.muted = false;
                const playPromise = video.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => hidePlayIndicator(wrapper))
                               .catch(error => console.error("Error al reproducir video:", error));
                }
            });
            wrapper.appendChild(playIndicator);
        }

        // ==== NUEVO: Funciones para manejar los modales de "seguir" ====
        function showFollowModal(message) {
            const followModal = document.getElementById('follow-modal');
            const followMessage = document.getElementById('follow-message');
            followMessage.textContent = message;
            followModal.classList.add('show');
            setTimeout(() => followModal.classList.remove('show'), 2500);
        }

        function showFollowConfirmModal(username) {
            targetUserToFollow = username;
            followConfirmUsernameSpan.textContent = `@${username}`;
            resetSlider(); 
            followConfirmModal.classList.add('show');
        }

        function hideFollowConfirmModal() {
            followConfirmModal.classList.remove('show');
            targetUserToFollow = null;
        }

        function resetSlider() {
            sliderThumb.style.transition = 'left 0.3s ease';
            sliderThumb.style.left = '4px';
            sliderContainer.querySelector('.slider-text').style.opacity = 1;
            setTimeout(() => {
                 sliderThumb.style.transition = ''; 
            }, 300);
        }

       // Funciones para manejar el estado de seguimiento en localStorage
        function getFollowedUsers() {
            if (!loggedInUser) return new Set();
            const key = `followedUsers_${loggedInUser.username}`;
            const stored = localStorage.getItem(key);
            return stored ? new Set(JSON.parse(stored)) : new Set();
        }

        function saveFollowedUser(username) {
            if (!loggedInUser) return;
            const key = `followedUsers_${loggedInUser.username}`;
            const followed = getFollowedUsers();
            followed.add(username);
            localStorage.setItem(key, JSON.stringify([...followed]));
        }

        function removeFollowedUser(username) {
            if (!loggedInUser) return;
            const key = `followedUsers_${loggedInUser.username}`;
            const followed = getFollowedUsers();
            followed.delete(username);
            localStorage.setItem(key, JSON.stringify([...followed]));
        }

        function isUserFollowed(username) {
            if (!loggedInUser) return false;
            const followed = getFollowedUsers();
            return followed.has(username);
        }

        // Funciones para manejar el estado de likes en localStorage
        function getLikedVideos() {
            if (!loggedInUser) return new Set();
            const key = `likedVideos_${loggedInUser.username}`;
            const stored = localStorage.getItem(key);
            return stored ? new Set(JSON.parse(stored)) : new Set();
        }

        function saveLikedVideo(videoId) {
            if (!loggedInUser) return;
            const key = `likedVideos_${loggedInUser.username}`;
            const liked = getLikedVideos();
            liked.add(videoId);
            localStorage.setItem(key, JSON.stringify([...liked]));
        }

        function removeLikedVideo(videoId) {
            if (!loggedInUser) return;
            const key = `likedVideos_${loggedInUser.username}`;
            const liked = getLikedVideos();
            liked.delete(videoId);
            localStorage.setItem(key, JSON.stringify([...liked]));
        }

        function isVideoLiked(videoId) {
            if (!loggedInUser) return false;
            const liked = getLikedVideos();
            return liked.has(videoId);
        }

       async function executeFollow() {
    if (!targetUserToFollow || !loggedInUser) return;

    sliderThumb.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    try {
        const result = await API.followUser(loggedInUser.username, targetUserToFollow);
        
        // Guardar en localStorage INMEDIATAMENTE
        if (result.success) {
            saveFollowedUser(targetUserToFollow);
        }
        
            // ELIMINAR el bot√≥n INMEDIATAMENTE - hacerlo de forma s√≠ncrona antes de cualquier otra cosa
            const currentWrapper = loadedVideoElements[currentVideoIndex];
            if (currentWrapper && currentWrapper.videoData && currentWrapper.videoData.user === `@${targetUserToFollow}`) {
                let followBtn = currentWrapper.videoData.followButtonElement;
                if (!followBtn) {
                    followBtn = currentWrapper.querySelector('.follow-button[data-target-user="' + targetUserToFollow + '"]');
                }
                if (!followBtn) {
                    followBtn = currentWrapper.querySelector('.follow-button');
                }
                if (followBtn) {
                    // ELIMINAR el bot√≥n completamente
                    followBtn.remove();
                    currentWrapper.videoData.isFollowingUser = true;
                    currentWrapper.videoData.followButtonElement = null;
                }
            }
        
        // Actualizar todos los videos
        updateAllVideosFollowStatus(targetUserToFollow, true);
        
        hideFollowConfirmModal();

        if (result.success) {
            showFollowModal(result.message || 'Ahora sigues a este usuario');
        } else {
            if (result.message && result.message.includes("Ya sigues")) {
                // Ya estaba oculto, pero asegurarse
                saveFollowedUser(targetUserToFollow); // Guardar por si acaso
                updateAllVideosFollowStatus(targetUserToFollow, true);
            }
            showFollowModal(result.message || 'Error al seguir');
        }
    } catch (error) {
        hideFollowConfirmModal();
        showFollowModal('Error al seguir el canal.');
        console.error("Error al seguir:", error);
    } finally {
        sliderThumb.innerHTML = '<i class="fas fa-chevron-right"></i>';
        resetSlider();
    }
}


        function updateAllVideosFollowStatus(username, isFollowing) {
            // Actualizar el video actualmente visible primero - usar referencia directa si existe
            const currentWrapper = loadedVideoElements[currentVideoIndex];
            if (currentWrapper && currentWrapper.videoData && currentWrapper.videoData.user === `@${username}`) {
                currentWrapper.videoData.isFollowingUser = isFollowing;
                
                // Intentar usar referencia directa primero
                let followBtn = currentWrapper.videoData.followButtonElement;
                
                // Si no existe, buscar en el DOM
                if (!followBtn) {
                    followBtn = currentWrapper.querySelector('.follow-button[data-target-user="' + username + '"]');
                }
                
                // Si a√∫n no se encuentra, buscar cualquier bot√≥n de seguir
                if (!followBtn) {
                    followBtn = currentWrapper.querySelector('.follow-button');
                }
                
                if (followBtn) {
                    if (isFollowing) {
                        // ELIMINAR el bot√≥n completamente en lugar de solo ocultarlo
                        followBtn.remove();
                        currentWrapper.videoData.followButtonElement = null;
                        currentWrapper.videoData.isFollowingUser = true;
                    } else {
                        followBtn.style.display = 'flex';
                        followBtn.style.visibility = 'visible';
                        followBtn.style.opacity = '1';
                        followBtn.style.pointerEvents = 'auto';
                        // Actualizar la referencia
                        currentWrapper.videoData.followButtonElement = followBtn;
                    }
                } else {
                    console.log('‚ö†Ô∏è No se encontr√≥ el bot√≥n de seguir para @' + username);
                }
            }
            
            // Actualizar todos los videos cargados
            loadedVideoElements.forEach((wrapper, index) => {
                if (wrapper.videoData && wrapper.videoData.user === `@${username}`) {
                    wrapper.videoData.isFollowingUser = isFollowing;
                    
                    let followBtn = wrapper.videoData.followButtonElement;
                    if (!followBtn) {
                        followBtn = wrapper.querySelector('.follow-button[data-target-user="' + username + '"]');
                    }
                    if (!followBtn) {
                        followBtn = wrapper.querySelector('.follow-button');
                    }
                    
                    if (followBtn) {
                        if (isFollowing) {
                            // ELIMINAR el bot√≥n completamente en lugar de solo ocultarlo
                            followBtn.remove();
                            wrapper.videoData.followButtonElement = null;
                            wrapper.videoData.isFollowingUser = true;
                        } else {
                            followBtn.style.display = 'flex';
                            followBtn.style.visibility = 'visible';
                            followBtn.style.opacity = '1';
                            followBtn.style.pointerEvents = 'auto';
                        }
                    }
                }
            });
            
            // Actualizar las listas de videos
            videosToPlayQueue.forEach(video => {
                if (video.user === `@${username}`) {
                    video.isFollowingUser = isFollowing;
                }
            });
            allVideosMasterList.forEach(video => {
                if (video.user === `@${username}`) {
                    video.isFollowingUser = isFollowing;
                }
            });
        }


        function hidePlayIndicator(wrapper) {
            const existingIndicator = wrapper.querySelector('.play-indicator');
            if (existingIndicator) existingIndicator.remove();
        }

        async function initialize() {
            loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            if (loggedInUser?.imageUrl) {
                document.querySelector('.my-profile-picture').style.backgroundImage = `url('${loggedInUser.imageUrl}')`;
                document.querySelector('.my-avatar-comment').style.backgroundImage = `url('${loggedInUser.imageUrl}')`;
            }
            loadingSpinner.style.display = 'block';
            
            // SIEMPRE obtener los datos m√°s recientes del backend al inicializar
            allVideosMasterList = await fetchAllVideoMetadata();
            
            if (allVideosMasterList.length > 0) {
                await restoreVideoState();
                if (videosToPlayQueue.length === 0) {
                    videosToPlayQueue = [...allVideosMasterList];
                    shuffleArray(videosToPlayQueue);
                }
                
                // Asegurar que videosToPlayQueue tenga los datos actualizados
                videosToPlayQueue = videosToPlayQueue.map(video => {
                    const updatedVideo = allVideosMasterList.find(v => v.videoId === video.videoId);
                    return updatedVideo || video;
                });
                
                const initialLoadCount = Math.min(3, videosToPlayQueue.length);
                for (let i = 0; i < initialLoadCount; i++) {
                    const videoData = videosToPlayQueue.shift();
                    // Asegurar que el videoData tenga los datos m√°s recientes
                    const latestVideoData = allVideosMasterList.find(v => v.videoId === videoData.videoId) || videoData;
                    const newVideoElement = createVideoElement(latestVideoData);
                    videoContainer.appendChild(newVideoElement);
                    loadedVideoElements.push(newVideoElement);
                }
                loadingSpinner.style.display = 'none';
                updateVideoState();
            } else {
                loadingSpinner.innerHTML = `<img src="https://i.postimg.cc/PJm3mRTH/image.png" alt="Likering Logo"><p>No hay videos disponibles.</p>`;
            }
        }

        let isSwiping = false;
        let startY = 0;
        const handleSwipe = (direction) => {
            if (isSwiping) return;
            isSwiping = true;
            const newIndex = currentVideoIndex + direction;
            if (newIndex >= 0 && newIndex < loadedVideoElements.length) {
                currentVideoIndex = newIndex;
                saveCurrentVideoState();
                if (direction > 0 && currentVideoIndex === loadedVideoElements.length - 1) {
                    if (videosToPlayQueue.length === 0) replenishVideoQueue();
                    const nextVideoData = videosToPlayQueue.shift();
                    if (nextVideoData) {
                        // Asegurar que el videoData tenga los datos m√°s recientes de allVideosMasterList
                        const latestVideoData = allVideosMasterList.find(v => v.videoId === nextVideoData.videoId) || nextVideoData;
                        const newVideoElement = createVideoElement(latestVideoData);
                        videoContainer.appendChild(newVideoElement);
                        loadedVideoElements.push(newVideoElement);
                    }
                }
                if (loadedVideoElements.length > 5) {
                    if (direction > 0) {
                        loadedVideoElements[0].remove();
                        loadedVideoElements.shift();
                        currentVideoIndex--;
                    }
                }
                updateVideoState();
            }
            setTimeout(() => { isSwiping = false; }, 450);
        };
        videoContainer.addEventListener('wheel', e => {
            e.preventDefault();
            handleSwipe(e.deltaY > 0 ? 1 : -1);
        }, { passive: false });
        videoContainer.addEventListener('touchstart', e => { startY = e.touches[0].clientY; }, { passive: true });
        videoContainer.addEventListener('touchend', e => {
            const endY = e.changedTouches[0].clientY;
            const deltaY = startY - endY;
            if (Math.abs(deltaY) > 50) handleSwipe(deltaY > 0 ? 1 : -1);
        }, { passive: true });
        
        // ==== NUEVO: Event Listeners para el slider de confirmaci√≥n ====
        cancelFollowBtn.addEventListener('click', hideFollowConfirmModal);

        const startSlide = (e) => {
            isSliding = true;
            sliderThumb.style.cursor = 'grabbing';
            sliderThumb.style.transition = 'none';
            sliderContainer.querySelector('.slider-text').style.opacity = 0;
            startX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            initialThumbX = sliderThumb.offsetLeft;
        };

        const onSlide = (e) => {
            if (!isSliding) return;
            e.preventDefault();
            const currentX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            let moveX = currentX - startX;
            let newLeft = Math.max(4, Math.min(initialThumbX + moveX, sliderContainer.offsetWidth - sliderThumb.offsetWidth - 4));
            sliderThumb.style.left = `${newLeft}px`;
        };

        const endSlide = (e) => {
            if (!isSliding) return;
            isSliding = false;
            sliderThumb.style.cursor = 'grab';
            const threshold = sliderContainer.offsetWidth * 0.7;
            if (sliderThumb.offsetLeft + sliderThumb.offsetWidth > threshold) {
                 sliderThumb.style.left = `${sliderContainer.offsetWidth - sliderThumb.offsetWidth - 4}px`;
                 executeFollow();
            } else {
                resetSlider();
            }
        };

        sliderThumb.addEventListener('mousedown', startSlide);
        document.addEventListener('mousemove', onSlide);
        document.addEventListener('mouseup', endSlide);
        sliderThumb.addEventListener('touchstart', startSlide, { passive: false });
        document.addEventListener('touchmove', onSlide, { passive: false });
        document.addEventListener('touchend', endSlide);

        const profileBadge = document.querySelector('.my-profile-badge');
        const profileMenuContainer = document.querySelector('.floating-menu-container');
        const floatingMenu = document.querySelector('.floating-menu');
        const optionsMenuContainer = document.querySelector('.options-menu-container');
        const optionsMenu = document.querySelector('.options-menu');
        const shareMenuContainer = document.querySelector('.share-menu-container');
        const closeShareButton = document.querySelector('.close-share');
        const shareButton = document.getElementById('share-btn');
        const downloadButton = document.getElementById('download-btn');
        const reportVideoButton = document.getElementById('report-video-btn');
        const downloadOverlay = document.querySelector('.download-progress-overlay');
        const downloadStatus = document.getElementById('download-status');
        const reportVideoModal = document.getElementById('report-video-modal');
        const cancelReportVideoBtn = document.getElementById('cancel-report-video-btn');
        const submitReportVideoBtn = document.getElementById('submit-report-video-btn');

        profileBadge.addEventListener('click', e => {
            e.stopPropagation();
            profileMenuContainer.classList.toggle('active')
        });
        profileMenuContainer.addEventListener('click', () => profileMenuContainer.classList.remove('active'));
        floatingMenu.addEventListener('click', e => e.stopPropagation());
        optionsMenuContainer.addEventListener('click', () => optionsMenuContainer.classList.remove('active'));
        optionsMenu.addEventListener('click', e => e.stopPropagation());
        shareButton.addEventListener('click', e => {
            e.stopPropagation();
            optionsMenuContainer.classList.remove('active');
            shareMenuContainer.classList.add('active');
        });
        closeShareButton.addEventListener('click', () => shareMenuContainer.classList.remove('active'));
        shareMenuContainer.addEventListener('click', e => {
            if (e.target === shareMenuContainer) shareMenuContainer.classList.remove('active')
        });
        downloadButton.addEventListener('click', async (e) => {
            e.stopPropagation();
            optionsMenuContainer.classList.remove('active');
            const currentVideoData = loadedVideoElements[currentVideoIndex]?.videoData;
            if (!currentVideoData || !currentVideoData.videoUrl) {
                alert('No se pudo encontrar la URL del video para descargar.');
                return;
            }
            downloadOverlay.classList.add('active');
            downloadStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparando descarga...';
            try {
                const response = await fetch(currentVideoData.videoUrl);
                if (!response.ok) throw new Error('No se pudo conectar con el servidor del video.');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                const filename = `${currentVideoData.user.substring(1)}_${currentVideoData.music.replace(/[^a-z0-9]/gi, '_')}.mp4`;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                downloadStatus.innerHTML = '<i class="fas fa-check-circle"></i> ¬°Descargado!';
                setTimeout(() => downloadOverlay.classList.remove('active'), 1500);
            } catch (error) {
                console.error('Error al descargar el video:', error);
                downloadStatus.innerHTML = '<i class="fas fa-times-circle"></i> Error al descargar';
                setTimeout(() => downloadOverlay.classList.remove('active'), 2500);
            }
        });
        
        // Funcionalidad de reportar video
        reportVideoButton.addEventListener('click', async (e) => {
            e.stopPropagation();
            optionsMenuContainer.classList.remove('active');
            
            if (!loggedInUser) {
                alert('Debes iniciar sesi√≥n para reportar videos.');
                window.location.href = 'index.html';
                return;
            }
            
            const currentVideoData = loadedVideoElements[currentVideoIndex]?.videoData;
            if (!currentVideoData) {
                alert('Error al obtener informaci√≥n del video.');
                return;
            }
            
            // Verificar si es su propio video
            const videoUsername = currentVideoData.user ? currentVideoData.user.replace('@', '') : '';
            if (loggedInUser.username === videoUsername) {
                alert('No puedes reportar tus propios videos.');
                return;
            }
            
            document.getElementById('report-video-username').textContent = currentVideoData.user || 'Usuario desconocido';
            reportVideoModal.classList.add('show');
            document.getElementById('report-video-reason').value = '';
            document.getElementById('report-video-description').value = '';
        });
        
        cancelReportVideoBtn.addEventListener('click', () => {
            reportVideoModal.classList.remove('show');
        });
        
        submitReportVideoBtn.addEventListener('click', async () => {
            const reason = document.getElementById('report-video-reason').value;
            const description = document.getElementById('report-video-description').value.trim();
            const currentVideoData = loadedVideoElements[currentVideoIndex]?.videoData;
            
            if (!reason) {
                alert('Por favor, selecciona un motivo para el reporte.');
                return;
            }
            
            if (!currentVideoData || !currentVideoData.videoId) {
                alert('Error al obtener informaci√≥n del video.');
                return;
            }
            
            submitReportVideoBtn.disabled = true;
            submitReportVideoBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
            
            try {
                // Obtener user_id del usuario que reporta
                let reporterUserId = loggedInUser.user_id || loggedInUser.id;
                
                // Si no tiene ID, intentar obtenerlo del backend
                if (!reporterUserId && loggedInUser.username) {
                    try {
                        const profileResult = await API.getUserProfile(loggedInUser.username);
                        if (profileResult.success && profileResult.data) {
                            reporterUserId = profileResult.data.id || profileResult.data.user_id;
                            // Actualizar loggedInUser en localStorage con el ID
                            if (reporterUserId) {
                                loggedInUser.id = reporterUserId;
                                loggedInUser.user_id = reporterUserId;
                                localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
                            }
                        }
                    } catch (profileError) {
                        console.error('Error al obtener perfil del usuario:', profileError);
                    }
                }
                
                if (!reporterUserId) {
                    throw new Error('No se pudo obtener tu informaci√≥n de usuario. Por favor, inicia sesi√≥n nuevamente.');
                }
                
                const reportData = {
                    tipo_reporte: 'video',
                    id_video_reportado: currentVideoData.videoId,
                    id_usuario_reporter: reporterUserId,
                    id_usuario_reportado: null, // El backend lo obtendr√° del video autom√°ticamente
                    motivo: reason,
                    descripcion: description || null
                };
                
                // Usar la URL base de config.js
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const RENDER_BACKEND_URL = 'https://likering-backend.onrender.com';
                const LOCAL_BACKEND_URL = 'http://localhost:3000';
                const BASE_URL = isLocalhost ? LOCAL_BACKEND_URL : RENDER_BACKEND_URL;
                const reportUrl = `${BASE_URL}/api/public/reports`;
                
                const response = await fetch(reportUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(reportData)
                });
                
                // Validar que la respuesta sea OK antes de parsear JSON
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error del servidor (${response.status}): ${errorText || 'Error desconocido'}`);
                }
                
                // Validar que la respuesta tenga contenido antes de parsear
                const text = await response.text();
                if (!text) {
                    throw new Error('El servidor no devolvi√≥ ninguna respuesta');
                }
                
                let result;
                try {
                    result = JSON.parse(text);
                } catch (parseError) {
                    console.error('Error al parsear respuesta:', parseError);
                    console.error('Respuesta recibida:', text);
                    throw new Error('El servidor devolvi√≥ una respuesta inv√°lida');
                }
                
                if (result.success) {
                    alert('¬°Reporte enviado correctamente! Los administradores lo revisar√°n pronto.');
                    reportVideoModal.classList.remove('show');
                    document.getElementById('report-video-reason').value = '';
                    document.getElementById('report-video-description').value = '';
                } else {
                    throw new Error(result.error || 'Error al enviar el reporte');
                }
            } catch (error) {
                console.error('Error al enviar reporte:', error);
                alert('Error al enviar el reporte: ' + error.message);
            } finally {
                submitReportVideoBtn.disabled = false;
                submitReportVideoBtn.innerHTML = 'Enviar';
            }
        });
        
        // Cerrar modal al hacer clic fuera
        reportVideoModal.addEventListener('click', (e) => {
            if (e.target === reportVideoModal) {
                reportVideoModal.classList.remove('show');
            }
        });

    document.getElementById('logout-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        e.preventDefault();
        
        const confirmLogout = confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?');
        if (confirmLogout) {
            localStorage.removeItem('loggedInUser');
            localStorage.removeItem('userVideos');
            localStorage.removeItem('userPreferences');
            window.location.href = 'index.html';
        }
        
        profileMenuContainer.classList.remove('active');
    });

        
        initialize();
        
        // Recargar estado de seguimiento cuando se vuelve a la p√°gina
        // Tambi√©n usar 'pageshow' para detectar cuando se vuelve desde el cache del navegador
        window.addEventListener('focus', async () => {
            console.log('[DEBUG] Window focused. Re-fetching video metadata and updating follow status.');
            await refreshFollowStatus();
        });
        
        window.addEventListener('pageshow', async (event) => {
            // event.persisted es true si la p√°gina se carg√≥ desde el cache
            if (event.persisted) {
                console.log('[DEBUG] Page loaded from cache. Re-fetching video metadata.');
                await refreshFollowStatus();
            }
        });
        
        async function refreshFollowStatus() {
            loggedInUser = JSON.parse(localStorage.getItem('loggedInUser')); // Recargar por si cambi√≥
            if (loggedInUser) {
                const updatedVideos = await fetchAllVideoMetadata();
                if (updatedVideos.length > 0) {
                    // Actualizar allVideosMasterList con los datos m√°s recientes
                    allVideosMasterList = updatedVideos;

                    // Recorrer los videos actualmente cargados en el DOM y actualizar su estado
                    loadedVideoElements.forEach(wrapper => {
                        const videoData = wrapper.videoData;
                        const updatedData = updatedVideos.find(v => v.videoId === videoData.videoId);
                        if (updatedData) {
                            // Normalizar nombres de usuario para comparaci√≥n
                            const videoUsername = videoData.user ? videoData.user.replace('@', '') : '';
                            const loggedInUsername = loggedInUser ? loggedInUser.username : '';
                            const isMyVideo = loggedInUser && videoUsername === loggedInUsername;
                            
                            // Verificar backend PRIMERO (fuente de verdad), luego localStorage para follows
                            const isFollowingFromBackend = updatedData.isFollowingUser;
                            const isFollowingInStorage = isUserFollowed(videoUsername);
                            
                            // Priorizar backend sobre localStorage (backend es fuente de verdad)
                            const isAlreadyFollowing = isFollowingFromBackend || isFollowingInStorage;
                            
                            // Sincronizar localStorage con backend
                            if (isFollowingFromBackend && !isFollowingInStorage) {
                                saveFollowedUser(videoUsername);
                            } else if (!isFollowingFromBackend && isFollowingInStorage) {
                                // Si el backend dice que no se sigue pero localStorage dice que s√≠, usar backend
                                removeFollowedUser(videoUsername);
                            }
                            
                            // Actualizar el estado de seguimiento
                            videoData.isFollowingUser = isAlreadyFollowing;
                            
                            // Verificar backend PRIMERO (fuente de verdad), luego localStorage
                            const isLikedFromBackend = updatedData.isLikedByCurrentUser;
                            const isLikedInStorage = isVideoLiked(videoData.videoId);
                            const isLiked = isLikedFromBackend || isLikedInStorage;
                            
                            // Sincronizar localStorage con el backend
                            if (isLikedFromBackend && !isLikedInStorage) {
                                saveLikedVideo(videoData.videoId);
                            }
                            
                            // Actualizar el estado de likes
                            videoData.isLikedByCurrentUser = isLiked;
                            
                            // Actualizar el coraz√≥n visualmente
                            const likeArea = wrapper.querySelector('.interaction-area');
                            if (likeArea) {
                                const iconDiv = likeArea.querySelector('.icon');
                                if (iconDiv) {
                                    if (isLiked) {
                                        iconDiv.classList.add('liked');
                                        if (!isLikedInStorage) {
                                            saveLikedVideo(videoData.videoId);
                                        }
                                    } else {
                                        iconDiv.classList.remove('liked');
                                    }
                                }
                            }
                            
                            const profileContainer = wrapper.querySelector('.profile-picture-container');
                            let followBtn = wrapper.videoData.followButtonElement || wrapper.querySelector('.follow-button');

                            if (isMyVideo || isAlreadyFollowing) {
                                // Si ahora se sigue o es su propio video, ELIMINAR el bot√≥n completamente
                                if (followBtn) {
                                    followBtn.remove();
                                    videoData.followButtonElement = null;
                                    videoData.isFollowingUser = true; // Asegurar que est√© en true
                                    // Asegurar que tambi√©n est√© en localStorage
                                    if (!isFollowingInStorage) {
                                        saveFollowedUser(videoUsername);
                                    }
                                    console.log(`[DEBUG] Bot√≥n de seguir para @${videoUsername} eliminado al volver a la p√°gina.`);
                                }
                            } else {
                                // Si no se sigue y no es su propio video, asegurar que el bot√≥n exista
                                if (!followBtn && !isMyVideo) {
                                    console.log(`[DEBUG] @${videoUsername} no seguido, recreando bot√≥n.`);
                                    const newFollowButton = document.createElement('div');
                                    newFollowButton.className = 'follow-button';
                                    newFollowButton.textContent = '+';
                                    newFollowButton.dataset.targetUser = videoUsername;
                                    newFollowButton.addEventListener('click', (e) => {
                                        e.stopPropagation();
                                        e.preventDefault();
                                        if (!loggedInUser) {
                                            alert("Debes iniciar sesi√≥n para seguir canales.");
                                            return;
                                        }
                                        showFollowConfirmModal(videoUsername);
                                    });
                                    if (profileContainer) {
                                        profileContainer.append(newFollowButton);
                                        videoData.followButtonElement = newFollowButton;
                                    }
                                }
                            }
                        }
                    });
                    // Tambi√©n actualizar videosToPlayQueue para futuros videos
                    videosToPlayQueue = videosToPlayQueue.map(video => {
                        const updatedData = updatedVideos.find(v => v.videoId === video.videoId);
                        if (updatedData) {
                            const videoUsername = video.user ? video.user.replace('@', '') : '';
                            const isFollowingFromBackend = updatedData.isFollowingUser;
                            const isFollowingInStorage = isUserFollowed(videoUsername);
                            
                            // Priorizar backend sobre localStorage (backend es fuente de verdad)
                            updatedData.isFollowingUser = isFollowingFromBackend || isFollowingInStorage;
                            
                            // Sincronizar localStorage con backend
                            if (isFollowingFromBackend && !isFollowingInStorage) {
                                saveFollowedUser(videoUsername);
                            } else if (!isFollowingFromBackend && isFollowingInStorage) {
                                // Si el backend dice que no se sigue pero localStorage dice que s√≠, usar backend
                                removeFollowedUser(videoUsername);
                            }
                            
                            // Actualizar likes tambi√©n - priorizar backend
                            const isLikedFromBackend = updatedData.isLikedByCurrentUser;
                            const isLikedInStorage = isVideoLiked(video.videoId);
                            updatedData.isLikedByCurrentUser = isLikedFromBackend || isLikedInStorage;
                            
                            // Sincronizar localStorage con el backend
                            if (isLikedFromBackend && !isLikedInStorage) {
                                saveLikedVideo(video.videoId);
                            }
                        }
                        return updatedData || video;
                    });
                }
            }
        }
    });

</script>
</body>
</html>