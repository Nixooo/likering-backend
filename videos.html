<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Likering Videos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    /* ===== DESIGN SYSTEM ===== */
    :root {
        --primary-pink: #FF2D7A;
        --primary-blue: #00A8FF;
        --gradient-1: linear-gradient(135deg, #FF2D7A 0%, #00A8FF 100%);
        --bg-primary: #0A0A0F;
        --bg-secondary: #141420;
        --bg-glass: rgba(255, 255, 255, 0.05);
        --bg-glass-hover: rgba(255, 255, 255, 0.08);
        --text-primary: #FFFFFF;
        --text-secondary: rgba(255, 255, 255, 0.7);
        --text-tertiary: rgba(255, 255, 255, 0.5);
        --border-color: rgba(255, 255, 255, 0.1);
        --border-hover: rgba(0, 168, 255, 0.3);
        --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.2);
        --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.4);
        --shadow-glow: 0 0 20px rgba(0, 168, 255, 0.3);
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --radius-xl: 24px;
        --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        --transition-base: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    * {
        box-sizing: border-box;
    }
    
    body {
        background-color: var(--bg-primary);
        margin: 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        overflow: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    .tiktok-app {
        width: 100%;
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: linear-gradient(135deg, #0A0A0F 0%, #000000 100%);
        position: relative;
        overflow: hidden;
    }

    .video-container {
        flex-grow: 1;
        position: relative;
        overflow: hidden;
        background: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        touch-action: pan-y;
    }


    .comment-item {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        position: relative;
        padding: 8px;
        border-radius: 12px;
        transition: background-color 0.3s ease;
    }

    .comment-item:hover {
        background-color: var(--bg-glass);
        border-radius: var(--radius-md);
    }

    .comment-message {
        background: var(--bg-glass);
        padding: 14px 18px;
        border-radius: var(--radius-lg);
        border-bottom-left-radius: var(--radius-sm);
        border: 1px solid var(--border-color);
        word-wrap: break-word;
        word-break: break-word;
        max-width: 100%;
        position: relative;
        backdrop-filter: blur(10px);
        transition: all var(--transition-base);
    }
    
    .comment-message:hover {
        background: var(--bg-glass-hover);
        border-color: var(--border-hover);
    }

    .comment-message.editing {
        background: var(--bg-glass-hover);
        border: 2px solid var(--primary-pink);
        box-shadow: 0 0 0 3px rgba(255, 45, 122, 0.1);
    }

    .comment-edit-input {
        background: transparent;
        border: none;
        color: #fff;
        font-size: 0.85rem;
        line-height: 1.4;
        width: 100%;
        resize: none;
        outline: none;
        min-height: 20px;
    }

    .comment-edit-input::placeholder {
        color: #888;
    }

    .comment-options {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-left: auto;
        opacity: 0;
        transition: opacity var(--transition-base);
    }

    .comment-item:hover .comment-options {
        opacity: 1;
    }

    .edit-comment-btn,
    .delete-comment-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        width: 32px;
        height: 32px;
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        font-size: 0.85rem;
        cursor: pointer;
        transition: all var(--transition-base);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        backdrop-filter: blur(10px);
    }

    .edit-comment-btn:hover {
        background: rgba(255, 165, 0, 0.15);
        border-color: rgba(255, 165, 0, 0.3);
        color: #ffa500;
        transform: scale(1.05);
    }

    .delete-comment-btn:hover {
        background: rgba(255, 71, 87, 0.15);
        border-color: rgba(255, 71, 87, 0.3);
        color: #ff4757;
        transform: scale(1.05);
    }

    .edit-comment-btn:active,
    .delete-comment-btn:active {
        transform: scale(0.95);
    }

    .comment-info {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 6px;
        font-size: 0.8rem;
        opacity: 0.8;
    }

    .comment-time {
        color: var(--text-tertiary);
        font-size: 0.8rem;
    }

    .comment-edited {
        color: #ffa500;
        font-style: italic;
    }

    .edit-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        justify-content: flex-end;
    }

    .edit-btn {
        padding: 8px 16px;
        border: 1.5px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-base);
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        color: var(--text-primary);
        font-family: 'Inter', sans-serif;
    }

    .edit-btn.save {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border-color: #28a745;
        color: white;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

    .edit-btn.cancel {
        background: rgba(255, 255, 255, 0.05);
        border-color: var(--border-color);
        color: var(--text-secondary);
    }

    .edit-btn:hover {
        transform: translateY(-2px);
    }
    
    .edit-btn.save:hover {
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.5);
    }
    
    .edit-btn.cancel:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: var(--border-hover);
        color: var(--text-primary);
    }

    .edit-btn:active {
        transform: translateY(0);
    }

    .edit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }





    /* Modal de eliminación de comentario */
    .comment-delete-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all var(--transition-base);
    }

    .comment-delete-modal.show {
        opacity: 1;
        visibility: visible;
    }

    .comment-delete-modal .modal-container {
        background: rgba(20, 20, 32, 0.98);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-xl);
        width: 90%;
        max-width: 420px;
        padding: 36px 32px;
        text-align: center;
        color: var(--text-primary);
        transform: scale(0.9) translateY(20px);
        transition: transform var(--transition-base), opacity var(--transition-base);
        opacity: 0;
        box-shadow: var(--shadow-lg), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
        backdrop-filter: blur(20px);
        position: relative;
        overflow: hidden;
    }
    
    .comment-delete-modal .modal-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, #ff4757, #ff2d7a);
    }

    .comment-delete-modal.show .modal-container {
        transform: scale(1) translateY(0);
        opacity: 1;
    }

    .comment-delete-modal h3 {
        margin: 0 0 15px 0;
        font-size: 1.2rem;
        color: #ff4757;
    }

    .comment-delete-modal p {
        margin: 0 0 20px 0;
        color: #ccc;
    }

    .comment-delete-modal .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
    }

    .comment-delete-modal button {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .comment-delete-modal .cancel-btn {
        background: #666;
        color: white;
    }

    .comment-delete-modal .delete-btn {
        background: linear-gradient(135deg, #ff4757 0%, #ff2d7a 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
    }

    .comment-delete-modal button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    }
    
    .comment-delete-modal .cancel-btn {
        background: var(--bg-glass);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
    }
    
    .comment-delete-modal .cancel-btn:hover {
        background: var(--bg-glass-hover);
        border-color: var(--border-hover);
    }

    .comment-delete-modal button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .floating-menu li#logout-btn {
        border-top: 1px solid var(--border-color);
        margin-top: 8px;
        padding-top: 16px;
        color: #ff4757;
    }

    .floating-menu li#logout-btn:hover {
        background: rgba(255, 71, 87, 0.15);
        color: #ff6b7a;
        border-color: rgba(255, 71, 87, 0.3);
    }

    .floating-menu li#logout-btn i {
        color: #ff4757;
    }

    .video-wrapper {
        position: absolute;
        width: 100%;
        height: 100%;
        color: #fff;
        transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        will-change: transform;
    }


    .follow-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(3px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .follow-modal-overlay.show {
        opacity: 1;
        visibility: visible;
    }

    /* ===== FOLLOW MODAL - Ultra Moderno ===== */
    .follow-modal-container {
        background: rgba(20, 20, 32, 0.98);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-xl);
        padding: 40px 32px;
        text-align: center;
        color: var(--text-primary);
        max-width: 340px;
        width: 90%;
        box-shadow: var(--shadow-lg), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
        transform: scale(0.9) translateY(30px);
        transition: transform var(--transition-base), opacity var(--transition-base);
        opacity: 0;
        position: relative;
        overflow: hidden;
    }
    
    .follow-modal-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, #28a745, #20c997);
    }

    .follow-modal-overlay.show .follow-modal-container {
        transform: scale(1) translateY(0);
        opacity: 1;
    }

    .follow-success-icon {
        font-size: 4rem;
        color: #28a745;
        margin-bottom: 20px;
        animation: successPulse 0.6s ease;
        filter: drop-shadow(0 0 20px rgba(40, 167, 69, 0.5));
    }

    @keyframes successPulse {
        0% { transform: scale(0) rotate(-180deg); opacity: 0; }
        50% { transform: scale(1.3) rotate(10deg); }
        100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }

    .follow-modal-container h3 {
        margin: 0 0 12px 0;
        font-size: 1.5rem;
        font-weight: 700;
        letter-spacing: -0.3px;
        color: var(--text-primary);
    }

    .follow-modal-container p {
        margin: 0;
        font-size: 1rem;
        color: var(--text-secondary);
        line-height: 1.5;
    }
    
    /* ===== REPORT MODAL - Ultra Moderno ===== */
    .report-modal-container {
        max-width: 420px;
    }
    
    .report-modal-container::before {
        background: linear-gradient(90deg, #ef4444, #ff2d7a);
    }
    
    .report-modal-title {
        margin: 0 0 20px 0 !important;
        font-size: 1.5rem !important;
        font-weight: 700 !important;
        color: #ef4444 !important;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        letter-spacing: -0.3px;
    }
    
    .report-modal-title i {
        font-size: 1.3em;
        filter: drop-shadow(0 0 10px rgba(239, 68, 68, 0.5));
    }
    
    .report-modal-text {
        margin: 0 0 24px 0 !important;
        color: var(--text-secondary) !important;
        font-size: 0.95rem;
        line-height: 1.6;
        text-align: center;
    }
    
    .report-modal-text strong {
        color: var(--text-primary);
        font-weight: 700;
    }
    
    .report-form-group {
        margin-bottom: 20px;
        text-align: left;
    }
    
    .report-label {
        display: block;
        margin-bottom: 10px;
        color: var(--text-primary);
        font-weight: 600;
        font-size: 0.95rem;
        letter-spacing: -0.2px;
    }
    
    .report-select,
    .report-textarea {
        width: 100%;
        padding: 14px 16px;
        background: var(--bg-glass);
        backdrop-filter: blur(10px);
        border: 1.5px solid var(--border-color);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 0.95rem;
        font-family: 'Inter', sans-serif;
        outline: none;
        transition: all var(--transition-base);
    }
    
    .report-select {
        cursor: pointer;
    }
    
    .report-select:hover {
        border-color: var(--border-hover);
        background: var(--bg-glass-hover);
    }
    
    .report-select:focus {
        border-color: var(--primary-blue);
        background: var(--bg-glass-hover);
        box-shadow: 0 0 0 4px rgba(0, 168, 255, 0.1);
    }
    
    .report-textarea {
        min-height: 100px;
        resize: vertical;
        line-height: 1.5;
    }
    
    .report-textarea:hover {
        border-color: var(--border-hover);
        background: var(--bg-glass-hover);
    }
    
    .report-textarea:focus {
        border-color: var(--primary-blue);
        background: var(--bg-glass-hover);
        box-shadow: 0 0 0 4px rgba(0, 168, 255, 0.1);
    }
    
    .report-textarea::placeholder {
        color: var(--text-tertiary);
    }
    
    .report-modal-actions {
        display: flex;
        gap: 12px;
        margin-top: 8px;
    }
    
    .report-cancel-btn {
        flex: 1;
    }
    
    .report-submit-btn {
        flex: 1;
        padding: 14px 20px;
        background: linear-gradient(135deg, #ef4444 0%, #ff2d7a 100%);
        border: none;
        border-radius: var(--radius-md);
        color: white;
        font-weight: 600;
        font-family: 'Inter', sans-serif;
        cursor: pointer;
        transition: all var(--transition-base);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        font-size: 0.95rem;
    }
    
    .report-submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
    }
    
    .report-submit-btn:active {
        transform: translateY(0);
    }
    
    .report-submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* ==== NUEVO: ESTILOS PARA MODAL DE CONFIRMACIÓN DE SEGUIR ==== */
    .follow-confirm-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1001;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .follow-confirm-modal-overlay.show {
        opacity: 1;
        visibility: visible;
    }

    .follow-confirm-modal-container {
        background: rgba(20, 20, 32, 0.98);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-xl);
        padding: 36px 32px;
        text-align: center;
        color: var(--text-primary);
        max-width: 360px;
        width: 90%;
        box-shadow: var(--shadow-lg), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
        backdrop-filter: blur(20px);
        transform: scale(0.9) translateY(20px);
        transition: transform var(--transition-base), opacity var(--transition-base);
        opacity: 0;
        position: relative;
        overflow: hidden;
    }
    
    .follow-confirm-modal-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--gradient-1);
    }

    .follow-confirm-modal-overlay.show .follow-confirm-modal-container {
        transform: scale(1) translateY(0);
        opacity: 1;
    }

    .follow-confirm-modal-container h3 {
        margin: 0 0 10px 0;
        font-size: 1.3rem;
        font-weight: 600;
        word-break: break-word;
    }

     .follow-confirm-modal-container h3 span {
        color: #fe2c55; 
     }

    .follow-confirm-modal-container p {
        margin: 0 0 25px 0;
        font-size: 0.9rem;
        color: #ccc;
        line-height: 1.4;
    }

    /* ===== SLIDER STYLES - Ultra Moderno ===== */
    .slider-container {
        width: 100%;
        padding: 0;
        box-sizing: border-box;
        margin-bottom: 28px;
        user-select: none;
    }

    .slider-track {
        position: relative;
        width: 100%;
        height: 56px;
        background: var(--bg-glass);
        backdrop-filter: blur(10px);
        border: 1.5px solid var(--border-color);
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        transition: all var(--transition-base);
    }
    
    .slider-track:hover {
        border-color: var(--border-hover);
        background: var(--bg-glass-hover);
    }

    .slider-thumb {
        position: absolute;
        left: 6px;
        top: 6px;
        width: 44px;
        height: 44px;
        background: var(--gradient-1);
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 1.1rem;
        cursor: grab;
        z-index: 2;
        box-shadow: var(--shadow-md), 0 0 0 3px rgba(255, 255, 255, 0.1);
        transition: all var(--transition-base);
    }

    .slider-thumb:active {
        cursor: grabbing;
        transform: scale(1.1);
        box-shadow: var(--shadow-lg), 0 0 0 5px rgba(255, 45, 122, 0.2);
    }

    .slider-text {
        color: var(--text-secondary);
        font-weight: 600;
        font-size: 0.9rem;
        z-index: 1;
        transition: opacity var(--transition-fast);
        letter-spacing: -0.2px;
    }

    .cancel-follow-btn {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        font-weight: 600;
        cursor: pointer;
        padding: 10px 20px;
        transition: all var(--transition-fast);
        font-size: 0.95rem;
        border-radius: var(--radius-md);
    }

    .cancel-follow-btn:hover {
        color: var(--text-primary);
        background: var(--bg-glass);
    }
     /* ==== FIN DE NUEVOS ESTILOS ==== */


    /* Responsive */
    @media (max-width: 480px) {
        .follow-modal-container {
            padding: 25px 20px;
            max-width: 280px;
        }
        
        .follow-success-icon {
            font-size: 2.5rem;
        }
        
        .follow-modal-container h3 {
            font-size: 1.2rem;
        }
        
        .follow-modal-container p {
            font-size: 0.9rem;
        }
    }


    /* ===== PLAY INDICATOR - Ultra Moderno ===== */
    .play-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90px;
        height: 90px;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2.2rem;
        cursor: pointer;
        z-index: 10;
        transition: all var(--transition-base);
        border: 3px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 0 4px rgba(255, 255, 255, 0.1);
        animation: playPulse 2.5s infinite ease-in-out;
    }

    .play-indicator:hover {
        background: rgba(0, 0, 0, 0.85);
        transform: translate(-50%, -50%) scale(1.15);
        border-color: var(--primary-blue);
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.7), 0 0 0 6px rgba(0, 168, 255, 0.2);
    }

    .play-indicator i {
        margin-left: 4px;
        filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.5));
    }

    @keyframes playPulse {
        0%, 100% {
            transform: translate(-50%, -50%) scale(1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 0 4px rgba(255, 255, 255, 0.1);
        }
        50% {
            transform: translate(-50%, -50%) scale(1.08);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6), 0 0 0 6px rgba(255, 255, 255, 0.15);
        }
    }

    /* Responsive para móviles */
    @media (max-width: 480px) {
        .play-indicator {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }
    }


    /* Responsive */
    @media (max-width: 480px) {
        .follow-modal-container {
            padding: 25px 20px;
            max-width: 280px;
        }
        
        .follow-success-icon {
            font-size: 2.5rem;
        }
        
        .follow-modal-container h3 {
            font-size: 1.2rem;
        }
        
        .follow-modal-container p {
            font-size: 0.9rem;
        }
    }



    .video-player {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 1;
        filter: brightness(1.02) contrast(1.05);
    }
    
    .video-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0.6) 0%,
            rgba(0, 0, 0, 0) 25%,
            rgba(0, 0, 0, 0) 75%,
            rgba(0, 0, 0, 0.7) 100%
        );
        z-index: 2;
        pointer-events: none;
    }
    
    /* ===== TOP LEFT INFO - Ultra Moderno ===== */
    .top-left-info {
        position: absolute;
        top: 50px;
        left: 24px;
        right: 80px;
        z-index: 3;
        display: flex;
        flex-direction: column;
        gap: 14px;
        pointer-events: none;
    }
    
    .top-left-info h3,
    .top-left-info .description,
    .top-left-info .music-info {
        pointer-events: auto;
    }
    
    .top-left-info h3 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 700;
        color: #fff;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8), 0 0 20px rgba(0, 0, 0, 0.5);
        letter-spacing: -0.3px;
        background: linear-gradient(135deg, #fff 0%, rgba(255, 255, 255, 0.9) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .top-left-info .description {
        font-size: 0.9rem;
        line-height: 1.5;
        margin: 0;
        color: rgba(255, 255, 255, 0.95);
        text-shadow: 0 2px 6px rgba(0, 0, 0, 0.7);
        font-weight: 400;
    }
    
    .top-left-info .music-info {
        display: flex;
        align-items: center;
        font-size: 0.85rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.9);
        text-shadow: 0 2px 6px rgba(0, 0, 0, 0.7);
        padding: 8px 14px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: var(--radius-md);
        border: 1px solid rgba(255, 255, 255, 0.15);
        width: fit-content;
        transition: all var(--transition-base);
    }
    
    .music-info:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.25);
        transform: translateX(4px);
    }
    
    .music-info i {
        margin-right: 10px;
        font-size: 1em;
        color: var(--primary-blue);
        filter: drop-shadow(0 0 8px rgba(0, 168, 255, 0.5));
    }
    
    /* ===== BOTTOM LEFT ACTIONS - Ultra Moderno ===== */
    .bottom-left-actions {
        position: absolute;
        bottom: 28px;
        left: 20px;
        z-index: 4;
        display: flex;
        align-items: flex-end;
        color: #fff;
        gap: 16px;
        pointer-events: none;
    }
    
    .bottom-left-actions > div {
        pointer-events: auto;
    }
    
    .profile-picture-container {
        position: relative;
        filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.4));
    }
    
    .profile-picture {
        width: 52px;
        height: 52px;
        border-radius: var(--radius-md);
        background-size: cover;
        border: 2.5px solid rgba(255, 255, 255, 0.9);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5), 0 0 0 2px rgba(255, 255, 255, 0.1);
        cursor: pointer;
        transition: all var(--transition-base);
        background-position: center;
    }
    
    .profile-picture:hover {
        transform: scale(1.08);
        border-color: var(--primary-blue);
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.6), 0 0 0 4px rgba(0, 168, 255, 0.2);
    }
    
    .follow-button {
        position: absolute;
        bottom: -10px;
        right: -10px;
        width: 24px;
        height: 24px;
        background: var(--gradient-1);
        border-radius: var(--radius-sm);
        display: flex;
        justify-content: center;
        align-items: center;
        color: #fff;
        font-size: 0.75rem;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(255, 45, 122, 0.4), 0 0 0 2px rgba(255, 255, 255, 0.1);
        transition: all var(--transition-base);
        border: none;
    }
    
    .follow-button:hover {
        transform: scale(1.15) rotate(5deg);
        box-shadow: 0 6px 20px rgba(255, 45, 122, 0.6), 0 0 0 3px rgba(255, 255, 255, 0.2);
    }
    
    .interaction-area {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        box-sizing: border-box;
        padding: 6px 8px;
        border-radius: var(--radius-md);
        transition: all var(--transition-base);
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .interaction-area:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(255, 255, 255, 0.1);
        transform: translateY(-1px);
    }
    
    .interaction-area .icon {
        font-size: 1.5em;
        cursor: pointer;
        color: rgba(255, 255, 255, 0.9);
        transition: all var(--transition-base);
        text-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
        margin-bottom: 0;
        filter: drop-shadow(0 0 4px rgba(0, 0, 0, 0.3));
    }
    
    .interaction-area .icon:hover {
        transform: scale(1.1);
        color: rgba(255, 255, 255, 1);
        filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.2));
    }
    
    .interaction-area .icon.liked {
        color: var(--primary-pink);
        transform: scale(1.05);
        filter: drop-shadow(0 0 10px rgba(255, 45, 122, 0.6));
        animation: heartBeat 0.5s ease-out;
    }
    
    @keyframes heartBeat {
        0%, 100% { transform: scale(1.05); }
        25% { transform: scale(1.2) rotate(-5deg); }
        75% { transform: scale(1.15) rotate(5deg); }
    }
    
    .interaction-area .count {
        font-size: 0.75rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.85);
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        letter-spacing: -0.2px;
    }
    /* ===== MY PROFILE BADGE - Ultra Moderno ===== */
    .my-profile-badge {
        position: absolute;
        right: 24px;
        bottom: 28px;
        z-index: 51;
        width: 52px;
        height: 52px;
        border-radius: var(--radius-md);
        cursor: pointer;
        overflow: visible;
        filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.4));
        transition: all var(--transition-base);
    }
    
    .my-profile-badge:hover {
        transform: scale(1.08) translateY(-2px);
        filter: drop-shadow(0 6px 20px rgba(0, 168, 255, 0.4));
    }
    
    .my-profile-picture {
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        border: 2.5px solid rgba(255, 255, 255, 0.9);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5), 0 0 0 2px rgba(255, 255, 255, 0.1);
        border-radius: var(--radius-md);
        box-sizing: border-box;
        transition: all var(--transition-base);
    }
    
    .my-profile-badge:hover .my-profile-picture {
        filter: brightness(0.9);
        border-color: var(--primary-blue);
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.6), 0 0 0 4px rgba(0, 168, 255, 0.2);
    }
    
    
    /* ===== OPTIONS ICON - Más Sutil ===== */
    .options-icon {
        position: absolute;
        top: 50px;
        right: 24px;
        font-size: 1.4em;
        color: rgba(255, 255, 255, 0.85);
        z-index: 3;
        cursor: pointer;
        text-shadow: 0 1px 4px rgba(0, 0, 0, 0.5);
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-full);
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        transition: all var(--transition-base);
    }
    
    .options-icon:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.15);
        color: rgba(255, 255, 255, 1);
        transform: scale(1.05);
    }
    /* ===== FLOATING MENUS - Ultra Moderno ===== */
    .floating-menu-container,
    .options-menu-container,
    .comments-panel-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 50;
        opacity: 0;
        visibility: hidden;
        transition: opacity var(--transition-base), visibility 0s 0.3s;
    }
    
    .floating-menu-container.active,
    .options-menu-container.active,
    .comments-panel-container.active {
        opacity: 1;
        visibility: visible;
        transition: opacity var(--transition-base);
    }
    
    .floating-menu-container,
    .options-menu-container {
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }
    
    .options-menu-container {
        z-index: 60;
        background: rgba(0, 0, 0, 0.5);
    }
    
    .floating-menu,
    .options-menu {
        position: absolute;
        width: 200px;
        background: rgba(20, 20, 32, 0.95);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        color: var(--text-primary);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-lg), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
        opacity: 0;
        transition: transform var(--transition-base), opacity var(--transition-base);
    }
    
    .floating-menu {
        bottom: 90px;
        right: 20px;
        transform: translateY(20px);
    }
    
    .options-menu {
        top: 90px;
        right: 20px;
        transform: translateY(-20px);
    }
    
    .floating-menu-container.active .floating-menu,
    .options-menu-container.active .options-menu {
        transform: translateY(0);
        opacity: 1;
    }
    
    .floating-menu::after,
    .options-menu::before {
        content: '';
        position: absolute;
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
    }
    
    .floating-menu::after {
        bottom: -10px;
        right: 30px;
        border-top: 10px solid rgba(20, 20, 32, 0.95);
    }
    
    .options-menu::before {
        top: -10px;
        right: 20px;
        border-bottom: 10px solid rgba(20, 20, 32, 0.95);
    }
    
    .floating-menu ul,
    .options-menu ul {
        list-style: none;
        margin: 0;
        padding: 8px;
    }
    
    .floating-menu li,
    .options-menu li {
        display: flex;
        align-items: center;
        padding: 14px 18px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        border-radius: var(--radius-md);
        transition: all var(--transition-fast);
        margin: 4px 0;
    }
    
    .floating-menu li:hover,
    .options-menu li:hover {
        background: var(--bg-glass-hover);
        transform: translateX(4px);
    }
    
    .floating-menu li i,
    .options-menu li i {
        width: 24px;
        margin-right: 14px;
        text-align: center;
        font-size: 1.1rem;
        color: var(--primary-blue);
    }
    
    .floating-menu a {
        text-decoration: none;
        color: inherit;
        display: flex;
        align-items: center;
        width: 100%;
    }
    
    /* ===== COMMENTS PANEL - Rediseño Completo ===== */
    .comments-panel-container {
        z-index: 70;
    }
    
    .comments-panel {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        background: linear-gradient(180deg, rgba(10, 10, 15, 0.98) 0%, rgba(20, 20, 32, 0.95) 100%);
        backdrop-filter: blur(40px) saturate(200%);
        -webkit-backdrop-filter: blur(40px) saturate(200%);
        border-top-left-radius: 28px;
        border-top-right-radius: 28px;
        border-top: 1px solid rgba(255, 255, 255, 0.15);
        transform: translateY(100%);
        display: flex;
        flex-direction: column;
        color: var(--text-primary);
        height: 75%;
        max-height: 650px;
        transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        box-shadow: 0 -12px 48px rgba(0, 0, 0, 0.5);
        position: fixed;
        overflow: hidden;
    }
    
    .comments-panel::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient-1);
        opacity: 0.6;
    }
    
    .comments-panel::after {
        content: '';
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        width: 50px;
        height: 5px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: var(--radius-full);
    }
    
    .comments-panel-container.active .comments-panel {
        transform: translateY(0);
    }
    
    .comments-header {
        text-align: center;
        padding: 24px 24px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
        flex-shrink: 0;
        background: rgba(255, 255, 255, 0.02);
    }
    
    .comments-header h4 {
        font-weight: 800;
        font-size: 1.25rem;
        letter-spacing: -0.5px;
        color: var(--text-primary);
        margin: 0;
        background: var(--gradient-1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .close-comments {
        position: absolute;
        top: 50%;
        right: 24px;
        transform: translateY(-50%);
        font-size: 1.2rem;
        color: var(--text-secondary);
        cursor: pointer;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-full);
        transition: all var(--transition-base);
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .close-comments:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
        transform: translateY(-50%) rotate(90deg) scale(1.1);
        border-color: rgba(255, 255, 255, 0.2);
    }
    
    .comments-list {
        flex-grow: 1;
        overflow-y: auto;
        padding: 24px;
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.15) transparent;
    }
    
    .comments-list::-webkit-scrollbar {
        width: 5px;
    }
    
    .comments-list::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .comments-list::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.15);
        border-radius: var(--radius-full);
    }
    
    .comments-list::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.25);
    }
    
    .comment-item {
        display: flex;
        gap: 10px;
        margin-bottom: 14px;
        padding: 8px;
        border-radius: var(--radius-md);
        transition: all var(--transition-fast);
    }
    
    .comment-item:hover {
        background: rgba(255, 255, 255, 0.02);
    }
    
    .comment-avatar {
        width: 32px;
        height: 32px;
        border-radius: var(--radius-sm);
        background-size: cover;
        background-position: center;
        flex-shrink: 0;
        border: 1.5px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        transition: all var(--transition-fast);
    }
    
    .comment-item:hover .comment-avatar {
        border-color: rgba(255, 255, 255, 0.2);
    }
    
    .comment-body {
        flex-grow: 1;
        min-width: 0;
    }
    
    .comment-user {
        font-weight: 600;
        font-size: 0.85rem;
        margin-bottom: 4px;
        color: var(--text-primary);
        letter-spacing: -0.2px;
    }
    
    .comment-text {
        font-size: 0.82rem;
        line-height: 1.4;
        color: var(--text-secondary);
        word-wrap: break-word;
    }
    
    .add-comment-area {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 20px 24px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(10, 10, 15, 0.6);
        flex-shrink: 0;
        backdrop-filter: blur(20px);
    }
    
    .my-avatar-comment {
        width: 44px;
        height: 44px;
        border-radius: var(--radius-md);
        background-size: cover;
        background-position: center;
        flex-shrink: 0;
        border: 2.5px solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .add-comment-area input {
        flex-grow: 1;
        padding: 16px 20px;
        border: 1.5px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-radius: var(--radius-xl);
        color: var(--text-primary);
        outline: none;
        font-size: 0.95rem;
        font-family: 'Inter', sans-serif;
        transition: all var(--transition-base);
    }
    
    .add-comment-area input:hover {
        border-color: rgba(255, 255, 255, 0.15);
        background: rgba(255, 255, 255, 0.08);
    }
    
    .add-comment-area input:focus {
        border-color: var(--primary-blue);
        background: rgba(255, 255, 255, 0.1);
        box-shadow: 0 0 0 4px rgba(0, 168, 255, 0.15);
    }
    
    .add-comment-area input::placeholder {
        color: var(--text-tertiary);
    }
    
    .add-comment-area .send-comment-btn {
        background: var(--gradient-1);
        border: none;
        color: #fff;
        font-size: 1.1rem;
        cursor: pointer;
        padding: 14px 18px;
        border-radius: var(--radius-md);
        transition: all var(--transition-base);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 16px rgba(255, 45, 122, 0.3);
        min-width: 50px;
    }
    
    .add-comment-area .send-comment-btn:hover {
        transform: scale(1.08);
        box-shadow: 0 6px 24px rgba(255, 45, 122, 0.5);
    }
    
    .add-comment-area .send-comment-btn:active {
        transform: scale(0.95);
    }
    /* ===== SHARE MODAL - Igual que Report Modal ===== */
    .share-modal-container {
        max-width: 380px;
    }
    
    .share-modal-container::before {
        background: var(--gradient-1);
    }
    
    .share-modal-title {
        margin: 0 0 24px 0 !important;
        font-size: 1.5rem !important;
        font-weight: 700 !important;
        color: var(--text-primary) !important;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        letter-spacing: -0.3px;
    }
    
    .share-modal-title i {
        font-size: 1.3em;
        background: var(--gradient-1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .share-modal-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .share-modal-option {
        display: flex;
        align-items: center;
        gap: 16px;
        cursor: pointer;
        padding: 16px 18px;
        border-radius: var(--radius-md);
        transition: all var(--transition-base);
        background: rgba(255, 255, 255, 0.03);
        border: 1.5px solid rgba(255, 255, 255, 0.05);
    }
    
    .share-modal-option:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.15);
        transform: translateX(4px);
    }
    
    .share-modal-icon {
        width: 50px;
        height: 50px;
        border-radius: var(--radius-md);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.6rem;
        color: #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: all var(--transition-base);
        position: relative;
        overflow: hidden;
        flex-shrink: 0;
    }
    
    .share-modal-option:hover .share-modal-icon {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }
    
    .share-modal-icon.whatsapp {
        background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
    }
    
    .share-modal-icon.instagram {
        background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285aeb 90%);
    }
    
    .share-modal-icon.copy-link {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }
    
    .share-modal-option span {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        letter-spacing: -0.2px;
        flex: 1;
    }
    /* ===== DOWNLOAD PROGRESS - Ultra Moderno ===== */
    .download-progress-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(10px);
        z-index: 999;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity var(--transition-base), visibility 0s 0.3s;
    }
    
    .download-progress-overlay.active {
        opacity: 1;
        visibility: visible;
        transition: opacity var(--transition-base);
    }
    
    .download-progress-box {
        background: rgba(20, 20, 32, 0.98);
        backdrop-filter: blur(30px) saturate(180%);
        color: var(--text-primary);
        padding: 28px 40px;
        border-radius: var(--radius-xl);
        text-align: center;
        font-weight: 600;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-lg);
    }
    
    .download-progress-box i {
        font-size: 1.8em;
        margin-right: 12px;
        color: var(--primary-blue);
        filter: drop-shadow(0 0 10px rgba(0, 168, 255, 0.5));
    }
    /* ===== LOADING SPINNER - Ultra Moderno ===== */
    .loading-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: var(--text-primary);
        z-index: 10;
    }
    
    .loading-spinner img {
        width: 100px;
        height: 100px;
        margin-bottom: 16px;
        filter: drop-shadow(0 0 30px rgba(0, 168, 255, 0.3));
        animation: logoFloat 2s ease-in-out infinite;
    }
    
    @keyframes logoFloat {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }
    
    .loading-spinner p {
        font-size: 1.1rem;
        font-weight: 600;
        letter-spacing: -0.3px;
        color: var(--text-secondary);
        margin: 0;
    }
    
    /* ===== VOLUME INDICATOR - Ultra Moderno ===== */
    .volume-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3.5em;
        color: rgba(255, 255, 255, 0.95);
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(20px);
        padding: 24px 32px;
        border-radius: var(--radius-xl);
        z-index: 5;
        opacity: 0;
        transition: opacity var(--transition-base);
        pointer-events: auto;
        box-shadow: var(--shadow-lg);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .volume-indicator.show {
        opacity: 1;
    }
    
    /* ===== RESPONSIVE - Mejorado ===== */
    @media (max-width: 768px) {
        .top-left-info {
            top: 12px;
            left: 16px;
            right: 60px;
            gap: 10px;
        }
        
        .top-left-info h3 {
            font-size: 0.95rem;
        }
        
        .top-left-info .description {
            font-size: 0.82rem;
        }
        
        .top-left-info .music-info {
            font-size: 0.75rem;
            padding: 6px 10px;
        }
        
        .options-icon {
            top: 12px;
            right: 16px;
            width: 32px;
            height: 32px;
            font-size: 1.2em;
        }
        
        .bottom-left-actions {
            left: 14px;
            bottom: 22px;
            gap: 14px;
        }
        
        .profile-picture {
            width: 46px;
            height: 46px;
        }
        
        .interaction-area {
            padding: 4px 6px;
        }
        
        .interaction-area .icon {
            font-size: 1.4em;
        }
        
        .interaction-area .count {
            font-size: 0.7rem;
        }
        
        .my-profile-badge {
            bottom: 28px;
            right: 16px;
            width: 46px;
            height: 46px;
        }
        
        .share-modal-container {
            max-width: 340px;
            padding: 32px 24px;
        }
        
        .share-modal-title {
            font-size: 1.3rem !important;
            margin-bottom: 20px !important;
        }
        
        .share-modal-option {
            padding: 14px 16px;
            gap: 14px;
        }
        
        .share-modal-icon {
            width: 44px;
            height: 44px;
            font-size: 1.4rem;
        }
        
        .share-modal-option span {
            font-size: 0.9rem;
        }
        
        .comments-panel {
            height: 80%;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }
        
        .comments-header {
            padding: 18px 18px 14px;
        }
        
        .comments-header h4 {
            font-size: 1.05rem;
        }
        
        .close-comments {
            right: 18px;
            width: 32px;
            height: 32px;
            font-size: 1.1rem;
        }
        
        .comments-list {
            padding: 16px;
        }
        
        .comment-item {
            margin-bottom: 12px;
            padding: 6px;
            gap: 8px;
        }
        
        .comment-avatar {
            width: 28px;
            height: 28px;
        }
        
        .comment-user {
            font-size: 0.8rem;
            margin-bottom: 3px;
        }
        
        .comment-text {
            font-size: 0.78rem;
            line-height: 1.35;
        }
        
        .add-comment-area {
            padding: 14px 16px;
            gap: 10px;
        }
        
        .my-avatar-comment {
            width: 36px;
            height: 36px;
        }
        
        .add-comment-area input {
            padding: 12px 14px;
            font-size: 0.85rem;
        }
        
        .add-comment-area .send-comment-btn {
            padding: 10px 14px;
            font-size: 0.95rem;
            min-width: 46px;
        }
    }
    
    @media (max-width: 480px) {
        .top-left-info {
            top: 10px;
            left: 14px;
            right: 55px;
            gap: 8px;
        }
        
        .top-left-info h3 {
            font-size: 0.9rem;
        }
        
        .top-left-info .description {
            font-size: 0.78rem;
        }
        
        .top-left-info .music-info {
            font-size: 0.7rem;
            padding: 5px 8px;
        }
        
        .options-icon {
            top: 10px;
            right: 14px;
            width: 30px;
            height: 30px;
            font-size: 1.1em;
        }
        
        .bottom-left-actions {
            left: 12px;
            bottom: 20px; 
            gap: 12px;
        }
        
        .profile-picture {
            width: 42px;
            height: 42px;
        }
        
        .interaction-area {
            padding: 3px 5px;
        }
        
        .interaction-area .icon {
            font-size: 1.3em;
        }
        
        .interaction-area .count {
            font-size: 0.65rem;
        }
        
        .my-profile-badge {
            bottom: 22px; 
            right: 14px;
            width: 42px;
            height: 42px;
        }
        
        .share-modal-container {
            max-width: 320px;
            padding: 28px 20px;
        }
        
        .share-modal-title {
            font-size: 1.2rem !important;
            margin-bottom: 18px !important;
        }
        
        .share-modal-option {
            padding: 12px 14px;
            gap: 12px;
        }
        
        .share-modal-icon {
            width: 40px;
            height: 40px;
            font-size: 1.3rem;
        }
        
        .share-modal-option span {
            font-size: 0.85rem;
        }
        
        .comments-panel {
            height: 85%;
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
        }
        
        .comments-header {
            padding: 16px 16px 12px;
        }
        
        .comments-header h4 {
            font-size: 1rem;
        }
        
        .close-comments {
            right: 16px;
            width: 30px;
            height: 30px;
            font-size: 1rem;
        }
        
        .comments-list {
            padding: 14px;
        }
        
        .comment-item {
            margin-bottom: 10px;
            padding: 5px;
            gap: 8px;
        }
        
        .comment-avatar {
            width: 26px;
            height: 26px;
        }
        
        .comment-user {
            font-size: 0.78rem;
            margin-bottom: 2px;
        }
        
        .comment-text {
            font-size: 0.75rem;
            line-height: 1.3;
        }
        
        .add-comment-area {
            padding: 12px 14px;
            gap: 8px;
        }
        
        .my-avatar-comment {
            width: 32px;
            height: 32px;
        }
        
        .add-comment-area input {
            padding: 10px 12px;
            font-size: 0.8rem;
        }
        
        .add-comment-area .send-comment-btn {
            padding: 8px 12px;
            font-size: 0.9rem;
            min-width: 42px;
        }
    }
</style>
</head>
<body>
    <div class="tiktok-app">
        <div class="video-container">
            <div class="loading-spinner" id="loading-spinner">
                <img src="https://i.postimg.cc/PJm3mRTH/image.png" alt="Likering Logo">
                <p>Cargando...</p>
            </div>
        </div>


        <div class="follow-modal-overlay" id="follow-modal">
            <div class="follow-modal-container">
                <div class="follow-modal-content">
                    <div class="follow-success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3>¡Listo!</h3>
                    <p id="follow-message">Ahora sigues a este canal</p>
                </div>
            </div>
        </div>

        <div class="follow-confirm-modal-overlay" id="follow-confirm-modal">
            <div class="follow-confirm-modal-container">
                <h3>¿Quieres seguir a <span id="follow-confirm-username"></span>?</h3>
                <p>Para confirmar, desliza el círculo hacia la derecha.</p>
                <div class="slider-container" id="follow-slider-container">
                    <div class="slider-track">
                        <div class="slider-thumb" id="follow-slider-thumb">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <span class="slider-text">Desliza para seguir</span>
                    </div>
                </div>
                <button class="cancel-follow-btn" id="cancel-follow-btn">Cancelar</button>
            </div>
        </div>
        
        <div class="my-profile-badge"><div class="my-profile-picture"></div></div>
        <div class="floating-menu-container"><div class="floating-menu"><ul><li><a href="billetera.html"><i class="fas fa-wallet"></i><span>Billetera</span></a></li><li><a href="mensajes.html"><i class="far fa-comments"></i><span>Mensajes</span></a></li><li><a href="perfil.html"><i class="fas fa-user-circle"></i><span>Perfil</span></a></li><li id="logout-btn"><i class="fas fa-sign-out-alt"></i><span>Cerrar Sesión</span></li></ul></div></div>
        <div class="options-menu-container"><div class="options-menu"><ul><li id="share-btn"><i class="fas fa-share-square"></i><span>Compartir</span></li><li id="download-btn"><i class="fas fa-download"></i><span>Descargar</span></li><li id="report-video-btn"><i class="fas fa-flag"></i><span>Reportar</span></li></ul></div></div>
        <div class="comments-panel-container"><div class="comments-panel"><div class="comments-header"><h4 id="comments-count">0 comentarios</h4><i class="fas fa-times close-comments"></i></div><div class="comments-list" id="comments-list"></div><div class="add-comment-area"><div class="my-avatar-comment"></div><input type="text" id="comment-input" placeholder="Añadir un comentario..."><button class="send-comment-btn" id="send-comment-btn"><i class="fas fa-arrow-right"></i></button></div></div></div>
        <!-- Modal de Compartir -->
        <div class="follow-modal-overlay" id="share-modal">
            <div class="follow-modal-container share-modal-container">
                <h3 class="share-modal-title"><i class="fas fa-share-alt"></i> Compartir</h3>
                <div class="share-modal-grid">
                    <div class="share-modal-option">
                        <div class="share-modal-icon whatsapp">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <span>WhatsApp</span>
                    </div>
                    <div class="share-modal-option">
                        <div class="share-modal-icon instagram">
                            <i class="fab fa-instagram"></i>
                        </div>
                        <span>Instagram</span>
                    </div>
                    <div class="share-modal-option">
                        <div class="share-modal-icon copy-link">
                            <i class="fas fa-link"></i>
                        </div>
                        <span>Copiar enlace</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="download-progress-overlay"><div class="download-progress-box"><span id="download-status"></span></div></div>
        
        <!-- Modal de Reportar Video -->
        <div class="follow-modal-overlay" id="report-video-modal">
            <div class="follow-modal-container report-modal-container">
                <h3 class="report-modal-title"><i class="fas fa-flag"></i> Reportar Video</h3>
                <p class="report-modal-text">Estás reportando un video de <strong id="report-video-username"></strong></p>
                <div class="report-form-group">
                    <label class="report-label">Motivo del reporte *</label>
                    <select id="report-video-reason" class="report-select">
                        <option value="">Selecciona un motivo</option>
                        <option value="Contenido inapropiado">Contenido inapropiado</option>
                        <option value="Spam o engañoso">Spam o engañoso</option>
                        <option value="Violencia">Violencia</option>
                        <option value="Derechos de autor">Derechos de autor</option>
                        <option value="Desinformación">Desinformación</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="report-form-group">
                    <label class="report-label">Descripción (opcional)</label>
                    <textarea id="report-video-description" placeholder="Proporciona más detalles..." class="report-textarea"></textarea>
                </div>
                <div class="report-modal-actions">
                    <button id="cancel-report-video-btn" class="cancel-follow-btn report-cancel-btn">Cancelar</button>
                    <button id="submit-report-video-btn" class="report-submit-btn">Enviar</button>
                </div>
            </div>
        </div>
    </div>

<script src="config.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const videoContainer = document.querySelector('.video-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const commentsList = document.getElementById('comments-list');
        const commentsCountHeader = document.getElementById('comments-count');

        let allVideosMasterList = [];
        let videosToPlayQueue = [];
        let loadedVideoElements = [];
        let currentVideoIndex = 0;
        let loggedInUser = null;

        // ––––– Selección de elementos del DOM –––––
        const commentsPanelContainer = document.querySelector('.comments-panel-container'); 
        const closeCommentsBtn       = document.querySelector('.close-comments');         // :contentReference[oaicite:4]{index=3}
        const commentInput           = document.querySelector('.add-comment-area input');
        const sendCommentBtn         = document.querySelector('.add-comment-area .send-comment-btn');

        // ==== NUEVO: Variables para el modal de confirmación ====
        let targetUserToFollow = null;
        const followConfirmModal = document.getElementById('follow-confirm-modal');
        const sliderThumb = document.getElementById('follow-slider-thumb');
        const sliderContainer = document.getElementById('follow-slider-container');
        const cancelFollowBtn = document.getElementById('cancel-follow-btn');
        const followConfirmUsernameSpan = document.getElementById('follow-confirm-username');
        let isSliding = false;
        let startX = 0;
        let initialThumbX = 0;


        // ––––– Cerrar panel de comentarios –––––
        closeCommentsBtn.addEventListener('click', () => {
          commentsPanelContainer.classList.remove('active');
        });

        // ––––– Enviar comentario –––––
        sendCommentBtn.addEventListener('click', postComment);
        commentInput.addEventListener('keypress', e => {
          if (e.key === 'Enter') postComment();
        });


        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        async function fetchAllVideoMetadata() {
    if (!loggedInUser) {
        console.error("Usuario no logueado.");
        return [];
    }
    try {
        const result = await API.getAllVideos(loggedInUser.username);
        
        if (!result.success) {
            throw new Error(result.message || 'Error desconocido del backend.');
        }
        
        return result.data.map(video => {
            // Convertir explícitamente is_following_user a booleano
            // El backend puede devolver true, false, null, o undefined
            const followingValue = video.is_following_user;
            let isFollowing = false;
            
            // Verificar explícitamente todos los casos
            if (followingValue === true) {
                isFollowing = true;
            } else if (followingValue === 'true' || followingValue === 'True' || followingValue === 'TRUE') {
                isFollowing = true;
            } else if (followingValue === 1 || followingValue === '1') {
                isFollowing = true;
            } else if (followingValue === false || followingValue === 'false' || followingValue === null || followingValue === undefined || followingValue === 0 || followingValue === '0') {
                isFollowing = false;
            } else {
                // Para cualquier otro valor, intentar convertir a booleano
                isFollowing = Boolean(followingValue);
            }
            
            // Verificar localStorage como fuente de verdad principal
            const videoUsername = video.user ? video.user.replace('@', '') : '';
            const isFollowingInStorage = isUserFollowed(videoUsername);
            
            // Usar localStorage si está disponible, sino usar el valor del backend
            const finalIsFollowing = isFollowingInStorage || isFollowing;
            
            // Debug log para verificar
            if (loggedInUser && video.user && video.user !== `@${loggedInUser.username}`) {
                console.log(`[FETCH] Video @${video.user.substring(1)}: backend=${isFollowing}, localStorage=${isFollowingInStorage}, final=${finalIsFollowing}`);
            }
            
            // Verificar localStorage para likes también
            const videoIdForLike = video.video_id || video.videoId;
            const isLikedInStorage = isVideoLiked(videoIdForLike);
            // El backend devuelve isLikedByCurrentUser (camelCase), no is_liked_by_current_user
            const isLikedFromBackend = Boolean(video.isLikedByCurrentUser || video.is_liked_by_current_user);
            // Priorizar backend sobre localStorage (el backend es la fuente de verdad)
            const finalIsLiked = isLikedFromBackend || isLikedInStorage;
            
            // Si el backend dice que está liked pero no está en localStorage, agregarlo
            if (isLikedFromBackend && !isLikedInStorage) {
                saveLikedVideo(videoIdForLike);
            }
            
            return {
                ...video,
                visualizaciones: parseInt(video.visualizaciones) || 0,
                videoId: videoIdForLike,
                profileImg: video.profile_img || video.profileImg,
                isLikedByCurrentUser: finalIsLiked, // Usar el valor combinado
                isFollowingUser: finalIsFollowing // Usar el valor combinado
            };
        });
    } catch (error) {
        console.error("Error al cargar metadatos de videos:", error);
        if (loadingSpinner) {
            loadingSpinner.innerHTML = `<img src="https://i.postimg.cc/PJm3mRTH/image.png" alt="Likering Logo"><p>Error al cargar videos.</p>`;
        }
        return [];
    }
}

        async function loadComments(videoId) {
    try {
        const result = await API.getComments(videoId);
        
        if (result.success) {
            displayComments(result.data);
        } else { 
            throw new Error(result.message); 
        }
    } catch (error) {
        commentsList.innerHTML = `<p style="text-align:center;color:red;">${error.message}</p>`;
    }
}


        function displayComments(comments) {
            commentsList.innerHTML = '';
            const count = comments.length;
            commentsCountHeader.textContent = `${count} comentario${count !== 1 ? 's' : ''}`;
            
            // Actualizar el contador en el video también
            const currentVideoData = loadedVideoElements[currentVideoIndex]?.videoData;
            if (currentVideoData) {
                currentVideoData.comments = count;
                const commentCountSpan = loadedVideoElements[currentVideoIndex]
                    ?.querySelector('.bottom-left-actions .interaction-area:nth-child(3) .count');
                if (commentCountSpan) {
                    commentCountSpan.textContent = count;
                }
            }

            if (comments.length === 0) {
                commentsList.innerHTML = '<p style="text-align:center;color:#888;">Sé el primero en comentar.</p>';
                return;
            }

            comments.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            comments.forEach(comment => {
                const commentItem = document.createElement('div');
                commentItem.className = 'comment-item';
                commentItem.dataset.commentId = comment.commentId || '';

                const timeAgo = getTimeAgo(new Date(comment.timestamp));
                const isMyComment = loggedInUser && comment.username === loggedInUser.username;
                const canEdit = isMyComment && isWithinEditTime(new Date(comment.timestamp));
                const editedBadge = comment.edited ? '<span style="color:#888;font-size:0.85em;margin-left:5px;">(editado)</span>' : '';

                commentItem.innerHTML = `
                    <div class="comment-avatar" style="background-image: url('${comment.imageUrl || ''}')"></div>
                    <div class="comment-body">
                        <div class="comment-user">${comment.username}${editedBadge}</div>
                        <div class="comment-message" data-original-text="${comment.commentText.replace(/"/g, '&quot;')}">
                            <span class="comment-text">${comment.commentText}</span>
                        </div>
                        <div class="comment-info">
                            <span class="comment-time">${timeAgo}</span>
                            ${isMyComment ? `
                                <div class="comment-options">
                                    ${canEdit ? `<button class="edit-comment-btn" onclick="editComment('${comment.commentId}')" title="Editar comentario"><i class="fas fa-edit"></i></button>` : ''}
                                    <button class="delete-comment-btn" onclick="deleteComment('${comment.commentId}')" title="Eliminar comentario"><i class="fas fa-trash"></i></button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                commentsList.appendChild(commentItem);
            });
        }

        function isWithinEditTime(timestamp) {
            const now = new Date();
            const diffMinutes = (now - timestamp) / (1000 * 60);
            return diffMinutes <= 5;
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMinutes < 1) return 'ahora';
            if (diffMinutes < 60) return `${diffMinutes}min`;
            if (diffHours < 24) return `${diffHours}h`;
            return `${diffDays}d`;
        }

        window.editComment = function(commentId) {
          const commentItem    = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
          if (!commentItem) return;
          const commentMessage = commentItem.querySelector('.comment-message');
          const commentText    = commentMessage.querySelector('.comment-text');
          const originalText   = commentMessage.dataset.originalText || commentText.textContent;
          const editInput = document.createElement('textarea');
          editInput.className    = 'comment-edit-input';
          editInput.value        = originalText;
          editInput.placeholder  = 'Edita tu comentario…';
          editInput.style.width  = '100%';
          editInput.style.boxSizing = 'border-box';
          const editActions = document.createElement('div');
          editActions.className = 'edit-actions';
          editActions.innerHTML = `
            <button class="edit-btn cancel" onclick="cancelEdit('${commentId}')">Cancelar</button>
            <button class="edit-btn save"   onclick="saveEdit('${commentId}')">Guardar</button>
          `;
          commentText.style.display = 'none';
          const opts = commentMessage.querySelector('.comment-options');
          if (opts) opts.style.display = 'none';
          commentMessage.classList.add('editing');
          commentMessage.append(editInput, editActions);
          editInput.focus();
          editInput.select();
        }

        window.cancelEdit = function(commentId) {
            const commentItem = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
            if (!commentItem) return;
            const commentMessage = commentItem.querySelector('.comment-message');
            const commentText = commentMessage.querySelector('.comment-text');
            const editInput = commentMessage.querySelector('.comment-edit-input');
            const editActions = commentMessage.querySelector('.edit-actions');
            if (editInput) editInput.remove();
            if (editActions) editActions.remove();
            if (commentText) commentText.style.display = 'block';
            const options = commentMessage.querySelector('.comment-options');
            if (options) options.style.display = 'flex';
            commentMessage.classList.remove('editing');
        }

        window.saveEdit = async function(commentId) {
    const commentItem = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
    if (!commentItem) return;
    const commentMessage = commentItem.querySelector('.comment-message');
    const editInput = commentMessage.querySelector('.comment-edit-input');
    if (!editInput) return;
    const newText = editInput.value.trim();
    
    if (!newText || !commentId) {
        alert('El comentario no puede estar vacío.');
        return;
    }
    
    const saveBtn = commentMessage.querySelector('.edit-btn.save');
    const cancelBtn = commentMessage.querySelector('.edit-btn.cancel');
    saveBtn.disabled = true;
    cancelBtn.disabled = true;
    saveBtn.textContent = 'Guardando...';
    
    try {
        const result = await API.editComment(commentId, newText, loggedInUser.username);
        
        if (result.success) {
            commentMessage.dataset.originalText = newText;
            commentMessage.querySelector('.comment-text').textContent = newText;
            cancelEdit(commentId);
            const commentInfo = commentItem.querySelector('.comment-info');
            if (!commentInfo.querySelector('.comment-edited')) {
                commentInfo.innerHTML += ' <span class="comment-edited">• editado</span>';
            }
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        alert(`Error al editar comentario: ${error.message}`);
    } finally {
        saveBtn.disabled = false;
        cancelBtn.disabled = false;
        saveBtn.textContent = 'Guardar';
    }
}

        let currentCommentId = null;

        window.deleteComment = function(commentId) {
            currentCommentId = commentId;
            showDeleteModal(commentId);
        }

        function showDeleteModal(commentId) {
          currentCommentId = commentId;
          let modal = document.getElementById('comment-delete-modal');
          if (!modal) {
                modal = document.createElement('div');
                modal.id = 'comment-delete-modal';
                modal.className = 'comment-delete-modal';
                modal.innerHTML = `
                    <div class="modal-container">
                        <h3><i class="fas fa-exclamation-triangle"></i> Eliminar comentario</h3>
                        <p>¿Estás seguro de que quieres eliminar este comentario?</p>
                        <div class="modal-actions">
                            <button class="cancel-btn" onclick="hideDeleteModal()">Cancelar</button>
                            <button class="delete-btn" onclick="confirmDeleteComment()">Eliminar</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
          modal.classList.add('show');
        }

        function hideDeleteModal() {
            const modal = document.getElementById('comment-delete-modal');
            if (modal) modal.classList.remove('show');
            currentCommentId = null;
        }

        async function confirmDeleteComment() {
    if (!currentCommentId) return;
    
    const modal = document.getElementById('comment-delete-modal');
    const deleteBtn = modal.querySelector('.delete-btn');
    const cancelBtn = modal.querySelector('.cancel-btn');
    deleteBtn.disabled = true;
    cancelBtn.disabled = true;
    deleteBtn.textContent = 'Eliminando...';
    
    try {
        const result = await API.deleteComment(currentCommentId, loggedInUser.username);
        
        if (result.success) {
            hideDeleteModal();
            const currentVideoData = loadedVideoElements[currentVideoIndex]?.videoData;
            if (currentVideoData?.videoId) {
                loadComments(currentVideoData.videoId);
                currentVideoData.comments = Math.max(0, (currentVideoData.comments || 1) - 1);
                const commentCountSpan = loadedVideoElements[currentVideoIndex]
                    .querySelector('.bottom-left-actions .interaction-area:nth-child(3) .count');
                if (commentCountSpan) commentCountSpan.textContent = currentVideoData.comments;
            }
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        alert(`Error al eliminar comentario: ${error.message}`);
    } finally {
        deleteBtn.disabled = false;
        cancelBtn.disabled = false;
        deleteBtn.textContent = 'Eliminar';
    }
}


        function saveCurrentVideoState() {
            if (loadedVideoElements[currentVideoIndex]?.videoData?.videoId) {
                localStorage.setItem('currentVideoId', loadedVideoElements[currentVideoIndex].videoData.videoId);
                localStorage.setItem('currentVideoIndex', currentVideoIndex.toString());
            }
        }

        async function restoreVideoState() {
            const savedVideoId = localStorage.getItem('currentVideoId');
            if (savedVideoId && allVideosMasterList.length > 0) {
                const videoIndex = allVideosMasterList.findIndex(video => video.videoId === savedVideoId);
                if (videoIndex !== -1) {
                    const savedVideo = allVideosMasterList[videoIndex];
                    videosToPlayQueue = [savedVideo, ...allVideosMasterList.filter(v => v.videoId !== savedVideoId)];
                    console.log(`🔄 Restaurando video: ${savedVideo.videoId}`);
                }
            }
        }

        async function postComment() {
    const commentText = commentInput.value.trim();
    if (!commentText || !loggedInUser) return;
    
    const currentVideoData = loadedVideoElements[currentVideoIndex]?.videoData;
    if (!currentVideoData || !currentVideoData.videoId) return;
    
    sendCommentBtn.disabled = true;
    sendCommentBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    try {
        const result = await API.addComment(
            currentVideoData.videoId, 
            loggedInUser.username, 
            commentText
        );
        
        if (result.success) {
            commentInput.value = '';
            // No incrementar manualmente, el backend ya lo hace
            // Recargar comentarios para obtener el contador actualizado
            await loadComments(currentVideoData.videoId);
            // Actualizar contador desde la respuesta del servidor o recargar el video
            const commentCountSpan = loadedVideoElements[currentVideoIndex]
                .querySelector('.bottom-left-actions .interaction-area:nth-child(3) .count');
            if (commentCountSpan) {
                // El contador se actualiza automáticamente cuando se recargan los comentarios
                // O podemos obtenerlo del header de comentarios
                const commentsHeader = document.getElementById('comments-count');
                if (commentsHeader) {
                    const count = parseInt(commentsHeader.textContent.match(/\d+/)?.[0] || '0');
                    commentCountSpan.textContent = count;
                    currentVideoData.comments = count;
                }
            }
        } else { 
            throw new Error(result.message); 
        }
    } catch (error) {
        alert(`Error al enviar comentario: ${error.message}`);
    } finally {
        sendCommentBtn.disabled = false;
        sendCommentBtn.innerHTML = '<i class="fas fa-arrow-right"></i>';
    }
}


       async function handleLikeClick(likeArea, videoId) {
    const iconDiv = likeArea.querySelector('.icon');
    const countSpan = likeArea.querySelector('.count');
    
    // Si ya tiene like, no hacer nada
    if (iconDiv.classList.contains('liked')) {
        return;
    }
    
    let currentLikes = parseInt(countSpan.textContent) || 0;
    
    // Agregar like visualmente
    iconDiv.classList.add('liked');
    countSpan.textContent = currentLikes + 1;
    saveLikedVideo(videoId);
    
    try {
        const result = await API.likeVideo(videoId, loggedInUser.username);
        
        if (result.success) {
            // Actualizar contador con el valor del servidor
            if (result.likes !== undefined) {
                countSpan.textContent = result.likes;
            }
        } else {
            // Revertir si falla
            iconDiv.classList.remove('liked');
            countSpan.textContent = currentLikes;
            removeLikedVideo(videoId);
        }
    } catch (error) {
        console.error("Error al registrar el like:", error);
        // Revertir si falla
        iconDiv.classList.remove('liked');
        countSpan.textContent = currentLikes;
        removeLikedVideo(videoId);
    }
}

       async function recordView(videoId, username) {
    const currentWrapper = loadedVideoElements[currentVideoIndex];
    if (currentWrapper.videoData.user === `@${username}`) {
        console.log("Vista propia, no contabilizada");
        return;
    }
    
    try {
        const result = await API.recordView(videoId, username);
        
        if (result.success && result.newViewCount !== undefined) {
            const wrapper = loadedVideoElements[currentVideoIndex];
            if (wrapper.videoData.videoId === videoId) {
                const viewsCountSpan = wrapper.querySelector('.interaction-area:nth-child(4) .count');
                if (viewsCountSpan) {
                    viewsCountSpan.textContent = result.newViewCount;
                    wrapper.videoData.visualizaciones = result.newViewCount;
                }
            }
        }
    } catch (error) {
        console.error("Error al registrar visualización:", error);
    }
}



        function replenishVideoQueue() {
            console.log("Cola de reproducción vacía. Rellenando y re-barajando...");
            // Asegurar que allVideosMasterList esté actualizado antes de rellenar
            videosToPlayQueue = [...allVideosMasterList];
            shuffleArray(videosToPlayQueue);
            const currentVideo = loadedVideoElements[currentVideoIndex];
            if (!currentVideo) return;
            const currentVidId = currentVideo.videoData.videoId;
            const prevVideo = loadedVideoElements[currentVideoIndex - 1];
            const prevVidId = prevVideo ? prevVideo.videoData.videoId : null;
            if (videosToPlayQueue.length > 1 && (videosToPlayQueue[0].videoId === currentVidId || videosToPlayQueue[0].videoId === prevVidId)) {
                videosToPlayQueue.push(videosToPlayQueue.shift());
            }
        }

         function createVideoElement(videoData) {
            const videoWrapper = document.createElement('div');
            videoWrapper.className = 'video-wrapper';
            videoWrapper.videoData = videoData;
            videoWrapper.userInteracted = false;
            
            const videoPlayer = document.createElement('video');
            videoPlayer.className = 'video-player';
            videoPlayer.src = videoData.videoUrl;
            videoPlayer.poster = videoData.thumbnailUrl;
            videoPlayer.loop = true;
            videoPlayer.playsInline = true;
            videoPlayer.muted = false;
            videoPlayer.preload = 'auto';
            videoPlayer.viewCounted = false;
            
            videoPlayer.addEventListener('timeupdate', () => {
                if (!loggedInUser || videoPlayer.viewCounted || isNaN(videoPlayer.duration) || loadedVideoElements[currentVideoIndex]?.querySelector('video') !== videoPlayer) {
                    return;
                }
                const percentageWatched = (videoPlayer.currentTime / videoPlayer.duration) * 100;
                if (percentageWatched > 70) {
                    recordView(videoData.videoId, loggedInUser.username);
                    videoPlayer.viewCounted = true;
                }
            });
            
            const videoOverlay = document.createElement('div');
            videoOverlay.className = 'video-overlay';
            
            const topLeftInfo = document.createElement('div');
            topLeftInfo.className = 'top-left-info';
            const musicHtml = (videoData.music && videoData.music.trim() !== '') 
                ? `<div class="music-info"><i class="fas fa-music"></i><span>${videoData.music}</span></div>` 
                : '';
            topLeftInfo.innerHTML = `<h3>${videoData.user}</h3><p class="description">${videoData.description}</p>${musicHtml}`;
            
            const bottomLeftActions = document.createElement('div');
            bottomLeftActions.className = 'bottom-left-actions';
            
            const profileContainer = document.createElement('div');
            profileContainer.className = 'profile-picture-container';
            
            const profilePicture = document.createElement('div');
            profilePicture.className = 'profile-picture';
            profilePicture.style.backgroundImage = `url('${videoData.profileImg}')`;

            const followButton = document.createElement('div');
            followButton.className = 'follow-button';
            followButton.textContent = '+';
            followButton.dataset.targetUser = videoData.user.substring(1); // Guardar el usuario objetivo
            
            // Verificar si es el propio video - normalizar ambos valores
            const videoUsername = videoData.user ? videoData.user.replace('@', '') : '';
            const loggedInUsername = loggedInUser ? loggedInUser.username : '';
            const isMyVideo = loggedInUser && videoUsername === loggedInUsername;
            
            // Verificar si ya sigue al usuario - PRIMERO verificar backend (fuente de verdad), luego localStorage
            const isFollowingValue = videoData.isFollowingUser;
            const isFollowingFromBackend = isFollowingValue === true || 
                                          isFollowingValue === 'true' ||
                                          String(isFollowingValue).toLowerCase() === 'true' ||
                                          Boolean(isFollowingValue) === true;
            const isFollowingInStorage = isUserFollowed(videoUsername);
            
            // Priorizar backend sobre localStorage (backend es fuente de verdad)
            const isAlreadyFollowing = isFollowingFromBackend || isFollowingInStorage;
            
            // Sincronizar localStorage con backend
            if (isFollowingFromBackend && !isFollowingInStorage) {
                saveFollowedUser(videoUsername);
            } else if (!isFollowingFromBackend && isFollowingInStorage) {
                // Si el backend dice que no se sigue pero localStorage dice que sí, usar backend
                removeFollowedUser(videoUsername);
            }

            // Debug: solo para usuarios que no son el propio
            if (loggedInUser && !isMyVideo) {
                const targetUsername = videoData.user.substring(1);
                console.log(`[DEBUG] Video de @${targetUsername}: localStorage=${isFollowingInStorage}, backend=${isFollowingValue}, final=${isAlreadyFollowing}, isMyVideo=${isMyVideo}`);
            }

            if (isMyVideo || isAlreadyFollowing) {
                // No agregar el botón si ya lo sigue o es su propio video
                profileContainer.append(profilePicture);
                videoData.followButtonElement = null;
                // Asegurar que isFollowingUser esté en true si ya se sigue
                if (isAlreadyFollowing && !isMyVideo) {
                    videoData.isFollowingUser = true;
                    // Asegurar que también esté en localStorage
                    if (!isFollowingInStorage) {
                        saveFollowedUser(videoUsername);
                    }
                }
            } else {
                // Agregar el botón y el event listener
                followButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    if (!loggedInUser) {
                        alert("Debes iniciar sesión para seguir canales.");
                        return;
                    }
                    const targetUser = videoData.user.substring(1);
                    showFollowConfirmModal(targetUser); // Llama al nuevo modal
                });
                profileContainer.append(profilePicture, followButton);
                // Guardar referencia al botón en el videoData para acceso rápido
                videoData.followButtonElement = followButton;
                // Asegurar que isFollowingUser esté en false si no se sigue
                videoData.isFollowingUser = false;
            }

            const likeArea = document.createElement('div');
            likeArea.className = 'interaction-area';
            likeArea.innerHTML = `<div class="icon"><i class="fas fa-heart"></i></div><span class="count">${videoData.likes}</span>`;
            
            // Verificar backend PRIMERO (fuente de verdad), luego localStorage
            const isLikedFromBackend = Boolean(videoData.isLikedByCurrentUser);
            const isLikedInStorage = isVideoLiked(videoData.videoId);
            const isLiked = isLikedFromBackend || isLikedInStorage;
            
            if (isLiked) {
                likeArea.querySelector('.icon').classList.add('liked');
                // Sincronizar localStorage con el backend
                if (isLikedFromBackend && !isLikedInStorage) {
                    saveLikedVideo(videoData.videoId);
                }
            }
            likeArea.addEventListener('click', (e) => {
                e.stopPropagation();
                if (videoData.user === `@${loggedInUser.username}`) {
                    alert("No puedes dar like a tus propios videos.");
                    return;
                }
                if (videoData.videoId && loggedInUser) {
                    handleLikeClick(likeArea, videoData.videoId);
                } else {
                    alert("Debes iniciar sesión para dar like.");
                }
            });
            
            const commentArea = document.createElement('div');
            commentArea.className = 'interaction-area';
            commentArea.innerHTML = `<div class="icon"><i class="far fa-comments"></i></div><span class="count">${videoData.comments}</span>`;
            if (videoData.videoId) {
                commentArea.addEventListener('click', (e) => {
                    e.stopPropagation();
                    loadComments(videoData.videoId);
                    commentsPanelContainer.classList.add('active');
                });
            }
            
            const viewsArea = document.createElement('div');
            viewsArea.className = 'interaction-area';
            viewsArea.innerHTML = `<div class="icon"><i class="fas fa-chart-bar"></i></div><span class="count">${videoData.visualizaciones}</span>`;
            
            bottomLeftActions.append(profileContainer, likeArea, commentArea, viewsArea);
            
            const optionsIcon = document.createElement('div');
            optionsIcon.className = 'options-icon';
            optionsIcon.innerHTML = `<i class="fas fa-ellipsis-h"></i>`;
            
            const volumeIndicator = document.createElement('div');
            volumeIndicator.className = 'volume-indicator';
            volumeIndicator.innerHTML = videoPlayer.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
            
            videoWrapper.addEventListener('click', (e) => {
                e.stopPropagation();
                if (videoPlayer.paused) {
                    videoPlayer.play();
                    hidePlayIndicator(videoWrapper);
                } else {
                    videoPlayer.pause();
                    showPlayIndicator(videoWrapper);
                }
            });

            volumeIndicator.addEventListener('click', (e) => {
                e.stopPropagation();
                videoPlayer.muted = !videoPlayer.muted;
                volumeIndicator.innerHTML = videoPlayer.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
                volumeIndicator.classList.add('show');
                setTimeout(() => volumeIndicator.classList.remove('show'), 800);
            });
            
            profilePicture.addEventListener('click', (e) => {
                e.stopPropagation();
                window.location.href = `streamer.html?user=${videoData.user.substring(1)}`;
            });
            
            optionsIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelector('.options-menu-container').classList.add('active');
            });
            
            videoWrapper.append(videoPlayer, videoOverlay, topLeftInfo, bottomLeftActions, optionsIcon, volumeIndicator);
            return videoWrapper;
        }


        function updateVideoState() {
            loadedVideoElements.forEach((wrapper, index) => {
                const video = wrapper.querySelector('video');
                const audio = wrapper.querySelector('audio');
                wrapper.style.transform = `translateY(${(index - currentVideoIndex) * 100}%)`;
                
                if (!video.src) {
                    video.src = wrapper.videoData.videoUrl;
                }
                
                if (index === currentVideoIndex) {
                    if (audio) {
                        audio.currentTime = 0;
                        audio.muted = false;
                        audio.play().catch(e => console.log("Fallo al reproducir audio:", e));
                    }
                    video.play().catch(e => {
                        console.log("Autoplay bloqueado, requiere interacción del usuario:", e);
                        showPlayIndicator(wrapper);
                    });
                } else {
                    video.pause();
                    video.currentTime = 0;
                    video.viewCounted = false;
                    if(audio) {
                        audio.pause();
                        audio.currentTime = 0;
                    }
                    hidePlayIndicator(wrapper);
                }
            });
        }


        function showPlayIndicator(wrapper) {
            hidePlayIndicator(wrapper);
            const playIndicator = document.createElement('div');
            playIndicator.className = 'play-indicator';
            playIndicator.innerHTML = '<i class="fas fa-play"></i>';
            playIndicator.addEventListener('click', (e) => {
                e.stopPropagation();
                const video = wrapper.querySelector('video');
                video.muted = false;
                const playPromise = video.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => hidePlayIndicator(wrapper))
                               .catch(error => console.error("Error al reproducir video:", error));
                }
            });
            wrapper.appendChild(playIndicator);
        }

        // ==== NUEVO: Funciones para manejar los modales de "seguir" ====
        function showFollowModal(message) {
            const followModal = document.getElementById('follow-modal');
            const followMessage = document.getElementById('follow-message');
            followMessage.textContent = message;
            followModal.classList.add('show');
            setTimeout(() => followModal.classList.remove('show'), 2500);
        }

        function showFollowConfirmModal(username) {
            targetUserToFollow = username;
            followConfirmUsernameSpan.textContent = `@${username}`;
            resetSlider(); 
            followConfirmModal.classList.add('show');
        }

        function hideFollowConfirmModal() {
            followConfirmModal.classList.remove('show');
            targetUserToFollow = null;
        }

        function resetSlider() {
            sliderThumb.style.transition = 'left 0.3s ease';
            sliderThumb.style.left = '4px';
            sliderContainer.querySelector('.slider-text').style.opacity = 1;
            setTimeout(() => {
                 sliderThumb.style.transition = ''; 
            }, 300);
        }

       // Funciones para manejar el estado de seguimiento en localStorage
        function getFollowedUsers() {
            if (!loggedInUser) return new Set();
            const key = `followedUsers_${loggedInUser.username}`;
            const stored = localStorage.getItem(key);
            return stored ? new Set(JSON.parse(stored)) : new Set();
        }

        function saveFollowedUser(username) {
            if (!loggedInUser) return;
            const key = `followedUsers_${loggedInUser.username}`;
            const followed = getFollowedUsers();
            followed.add(username);
            localStorage.setItem(key, JSON.stringify([...followed]));
        }

        function removeFollowedUser(username) {
            if (!loggedInUser) return;
            const key = `followedUsers_${loggedInUser.username}`;
            const followed = getFollowedUsers();
            followed.delete(username);
            localStorage.setItem(key, JSON.stringify([...followed]));
        }

        function isUserFollowed(username) {
            if (!loggedInUser) return false;
            const followed = getFollowedUsers();
            return followed.has(username);
        }

        // Funciones para manejar el estado de likes en localStorage
        function getLikedVideos() {
            if (!loggedInUser) return new Set();
            const key = `likedVideos_${loggedInUser.username}`;
            const stored = localStorage.getItem(key);
            return stored ? new Set(JSON.parse(stored)) : new Set();
        }

        function saveLikedVideo(videoId) {
            if (!loggedInUser) return;
            const key = `likedVideos_${loggedInUser.username}`;
            const liked = getLikedVideos();
            liked.add(videoId);
            localStorage.setItem(key, JSON.stringify([...liked]));
        }

        function removeLikedVideo(videoId) {
            if (!loggedInUser) return;
            const key = `likedVideos_${loggedInUser.username}`;
            const liked = getLikedVideos();
            liked.delete(videoId);
            localStorage.setItem(key, JSON.stringify([...liked]));
        }

        function isVideoLiked(videoId) {
            if (!loggedInUser) return false;
            const liked = getLikedVideos();
            return liked.has(videoId);
        }

       async function executeFollow() {
    if (!targetUserToFollow || !loggedInUser) return;

    sliderThumb.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    try {
        const result = await API.followUser(loggedInUser.username, targetUserToFollow);
        
        // Guardar en localStorage INMEDIATAMENTE
        if (result.success) {
            saveFollowedUser(targetUserToFollow);
        }
        
            // ELIMINAR el botón INMEDIATAMENTE - hacerlo de forma síncrona antes de cualquier otra cosa
            const currentWrapper = loadedVideoElements[currentVideoIndex];
            if (currentWrapper && currentWrapper.videoData && currentWrapper.videoData.user === `@${targetUserToFollow}`) {
                let followBtn = currentWrapper.videoData.followButtonElement;
                if (!followBtn) {
                    followBtn = currentWrapper.querySelector('.follow-button[data-target-user="' + targetUserToFollow + '"]');
                }
                if (!followBtn) {
                    followBtn = currentWrapper.querySelector('.follow-button');
                }
                if (followBtn) {
                    // ELIMINAR el botón completamente
                    followBtn.remove();
                    currentWrapper.videoData.isFollowingUser = true;
                    currentWrapper.videoData.followButtonElement = null;
                }
            }
        
        // Actualizar todos los videos
        updateAllVideosFollowStatus(targetUserToFollow, true);
        
        hideFollowConfirmModal();

        if (result.success) {
            showFollowModal(result.message || 'Ahora sigues a este usuario');
        } else {
            if (result.message && result.message.includes("Ya sigues")) {
                // Ya estaba oculto, pero asegurarse
                saveFollowedUser(targetUserToFollow); // Guardar por si acaso
                updateAllVideosFollowStatus(targetUserToFollow, true);
            }
            showFollowModal(result.message || 'Error al seguir');
        }
    } catch (error) {
        hideFollowConfirmModal();
        showFollowModal('Error al seguir el canal.');
        console.error("Error al seguir:", error);
    } finally {
        sliderThumb.innerHTML = '<i class="fas fa-chevron-right"></i>';
        resetSlider();
    }
}


        function updateAllVideosFollowStatus(username, isFollowing) {
            // Actualizar el video actualmente visible primero - usar referencia directa si existe
            const currentWrapper = loadedVideoElements[currentVideoIndex];
            if (currentWrapper && currentWrapper.videoData && currentWrapper.videoData.user === `@${username}`) {
                currentWrapper.videoData.isFollowingUser = isFollowing;
                
                // Intentar usar referencia directa primero
                let followBtn = currentWrapper.videoData.followButtonElement;
                
                // Si no existe, buscar en el DOM
                if (!followBtn) {
                    followBtn = currentWrapper.querySelector('.follow-button[data-target-user="' + username + '"]');
                }
                
                // Si aún no se encuentra, buscar cualquier botón de seguir
                if (!followBtn) {
                    followBtn = currentWrapper.querySelector('.follow-button');
                }
                
                if (followBtn) {
                    if (isFollowing) {
                        // ELIMINAR el botón completamente en lugar de solo ocultarlo
                        followBtn.remove();
                        currentWrapper.videoData.followButtonElement = null;
                        currentWrapper.videoData.isFollowingUser = true;
                    } else {
                        followBtn.style.display = 'flex';
                        followBtn.style.visibility = 'visible';
                        followBtn.style.opacity = '1';
                        followBtn.style.pointerEvents = 'auto';
                        // Actualizar la referencia
                        currentWrapper.videoData.followButtonElement = followBtn;
                    }
                } else {
                    console.log('⚠️ No se encontró el botón de seguir para @' + username);
                }
            }
            
            // Actualizar todos los videos cargados
            loadedVideoElements.forEach((wrapper, index) => {
                if (wrapper.videoData && wrapper.videoData.user === `@${username}`) {
                    wrapper.videoData.isFollowingUser = isFollowing;
                    
                    let followBtn = wrapper.videoData.followButtonElement;
                    if (!followBtn) {
                        followBtn = wrapper.querySelector('.follow-button[data-target-user="' + username + '"]');
                    }
                    if (!followBtn) {
                        followBtn = wrapper.querySelector('.follow-button');
                    }
                    
                    if (followBtn) {
                        if (isFollowing) {
                            // ELIMINAR el botón completamente en lugar de solo ocultarlo
                            followBtn.remove();
                            wrapper.videoData.followButtonElement = null;
                            wrapper.videoData.isFollowingUser = true;
                        } else {
                            followBtn.style.display = 'flex';
                            followBtn.style.visibility = 'visible';
                            followBtn.style.opacity = '1';
                            followBtn.style.pointerEvents = 'auto';
                        }
                    }
                }
            });
            
            // Actualizar las listas de videos
            videosToPlayQueue.forEach(video => {
                if (video.user === `@${username}`) {
                    video.isFollowingUser = isFollowing;
                }
            });
            allVideosMasterList.forEach(video => {
                if (video.user === `@${username}`) {
                    video.isFollowingUser = isFollowing;
                }
            });
        }


        function hidePlayIndicator(wrapper) {
            const existingIndicator = wrapper.querySelector('.play-indicator');
            if (existingIndicator) existingIndicator.remove();
        }

        async function initialize() {
            loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            if (loggedInUser?.imageUrl) {
                document.querySelector('.my-profile-picture').style.backgroundImage = `url('${loggedInUser.imageUrl}')`;
                document.querySelector('.my-avatar-comment').style.backgroundImage = `url('${loggedInUser.imageUrl}')`;
            }
            loadingSpinner.style.display = 'block';
            
            // SIEMPRE obtener los datos más recientes del backend al inicializar
            allVideosMasterList = await fetchAllVideoMetadata();
            
            if (allVideosMasterList.length > 0) {
                await restoreVideoState();
                if (videosToPlayQueue.length === 0) {
                    videosToPlayQueue = [...allVideosMasterList];
                    shuffleArray(videosToPlayQueue);
                }
                
                // Asegurar que videosToPlayQueue tenga los datos actualizados
                videosToPlayQueue = videosToPlayQueue.map(video => {
                    const updatedVideo = allVideosMasterList.find(v => v.videoId === video.videoId);
                    return updatedVideo || video;
                });
                
                const initialLoadCount = Math.min(3, videosToPlayQueue.length);
                for (let i = 0; i < initialLoadCount; i++) {
                    const videoData = videosToPlayQueue.shift();
                    // Asegurar que el videoData tenga los datos más recientes
                    const latestVideoData = allVideosMasterList.find(v => v.videoId === videoData.videoId) || videoData;
                    const newVideoElement = createVideoElement(latestVideoData);
                    videoContainer.appendChild(newVideoElement);
                    loadedVideoElements.push(newVideoElement);
                }
                loadingSpinner.style.display = 'none';
                updateVideoState();
            } else {
                loadingSpinner.innerHTML = `<img src="https://i.postimg.cc/PJm3mRTH/image.png" alt="Likering Logo"><p>No hay videos disponibles.</p>`;
            }
        }

        let isSwiping = false;
        let startY = 0;
        const handleSwipe = (direction) => {
            if (isSwiping) return;
            isSwiping = true;
            const newIndex = currentVideoIndex + direction;
            if (newIndex >= 0 && newIndex < loadedVideoElements.length) {
                currentVideoIndex = newIndex;
                saveCurrentVideoState();
                if (direction > 0 && currentVideoIndex === loadedVideoElements.length - 1) {
                    if (videosToPlayQueue.length === 0) replenishVideoQueue();
                    const nextVideoData = videosToPlayQueue.shift();
                    if (nextVideoData) {
                        // Asegurar que el videoData tenga los datos más recientes de allVideosMasterList
                        const latestVideoData = allVideosMasterList.find(v => v.videoId === nextVideoData.videoId) || nextVideoData;
                        const newVideoElement = createVideoElement(latestVideoData);
                        videoContainer.appendChild(newVideoElement);
                        loadedVideoElements.push(newVideoElement);
                    }
                }
                if (loadedVideoElements.length > 5) {
                    if (direction > 0) {
                        loadedVideoElements[0].remove();
                        loadedVideoElements.shift();
                        currentVideoIndex--;
                    }
                }
                updateVideoState();
            }
            setTimeout(() => { isSwiping = false; }, 450);
        };
        videoContainer.addEventListener('wheel', e => {
            e.preventDefault();
            handleSwipe(e.deltaY > 0 ? 1 : -1);
        }, { passive: false });
        videoContainer.addEventListener('touchstart', e => { startY = e.touches[0].clientY; }, { passive: true });
        videoContainer.addEventListener('touchend', e => {
            const endY = e.changedTouches[0].clientY;
            const deltaY = startY - endY;
            if (Math.abs(deltaY) > 50) handleSwipe(deltaY > 0 ? 1 : -1);
        }, { passive: true });
        
        // ==== NUEVO: Event Listeners para el slider de confirmación ====
        cancelFollowBtn.addEventListener('click', hideFollowConfirmModal);

        const startSlide = (e) => {
            isSliding = true;
            sliderThumb.style.cursor = 'grabbing';
            sliderThumb.style.transition = 'none';
            sliderContainer.querySelector('.slider-text').style.opacity = 0;
            startX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            initialThumbX = sliderThumb.offsetLeft;
        };

        const onSlide = (e) => {
            if (!isSliding) return;
            e.preventDefault();
            const currentX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            let moveX = currentX - startX;
            let newLeft = Math.max(4, Math.min(initialThumbX + moveX, sliderContainer.offsetWidth - sliderThumb.offsetWidth - 4));
            sliderThumb.style.left = `${newLeft}px`;
        };

        const endSlide = (e) => {
            if (!isSliding) return;
            isSliding = false;
            sliderThumb.style.cursor = 'grab';
            const threshold = sliderContainer.offsetWidth * 0.7;
            if (sliderThumb.offsetLeft + sliderThumb.offsetWidth > threshold) {
                 sliderThumb.style.left = `${sliderContainer.offsetWidth - sliderThumb.offsetWidth - 4}px`;
                 executeFollow();
            } else {
                resetSlider();
            }
        };

        sliderThumb.addEventListener('mousedown', startSlide);
        document.addEventListener('mousemove', onSlide);
        document.addEventListener('mouseup', endSlide);
        sliderThumb.addEventListener('touchstart', startSlide, { passive: false });
        document.addEventListener('touchmove', onSlide, { passive: false });
        document.addEventListener('touchend', endSlide);

        const profileBadge = document.querySelector('.my-profile-badge');
        const profileMenuContainer = document.querySelector('.floating-menu-container');
        const floatingMenu = document.querySelector('.floating-menu');
        const optionsMenuContainer = document.querySelector('.options-menu-container');
        const optionsMenu = document.querySelector('.options-menu');
        const shareModal = document.getElementById('share-modal');
        const shareButton = document.getElementById('share-btn');
        const downloadButton = document.getElementById('download-btn');
        const reportVideoButton = document.getElementById('report-video-btn');
        const downloadOverlay = document.querySelector('.download-progress-overlay');
        const downloadStatus = document.getElementById('download-status');
        const reportVideoModal = document.getElementById('report-video-modal');
        const cancelReportVideoBtn = document.getElementById('cancel-report-video-btn');
        const submitReportVideoBtn = document.getElementById('submit-report-video-btn');

        profileBadge.addEventListener('click', e => {
            e.stopPropagation();
            profileMenuContainer.classList.toggle('active')
        });
        profileMenuContainer.addEventListener('click', () => profileMenuContainer.classList.remove('active'));
        floatingMenu.addEventListener('click', e => e.stopPropagation());
        optionsMenuContainer.addEventListener('click', () => optionsMenuContainer.classList.remove('active'));
        optionsMenu.addEventListener('click', e => e.stopPropagation());
        shareButton.addEventListener('click', e => {
            e.stopPropagation();
            optionsMenuContainer.classList.remove('active');
            shareModal.classList.add('show');
        });
        shareModal.addEventListener('click', e => {
            if (e.target === shareModal) shareModal.classList.remove('show');
        });
        
        // Funcionalidad de compartir
        document.querySelectorAll('.share-modal-option').forEach(option => {
            option.addEventListener('click', async (e) => {
                e.stopPropagation();
                const currentVideoData = loadedVideoElements[currentVideoIndex]?.videoData;
                if (!currentVideoData) return;
                
                const videoUrl = window.location.origin + window.location.pathname + '?video=' + currentVideoData.videoId;
                const shareText = `Mira este video de ${currentVideoData.user}: ${currentVideoData.title}`;
                
                const optionType = option.querySelector('.share-modal-icon').classList.contains('whatsapp') ? 'whatsapp' :
                                  option.querySelector('.share-modal-icon').classList.contains('instagram') ? 'instagram' :
                                  'copy';
                
                if (optionType === 'whatsapp') {
                    window.open(`https://wa.me/?text=${encodeURIComponent(shareText + ' ' + videoUrl)}`, '_blank');
                } else if (optionType === 'instagram') {
                    // Instagram no permite compartir directamente, copiar enlace
                    await navigator.clipboard.writeText(videoUrl);
                    alert('Enlace copiado al portapapeles');
                } else if (optionType === 'copy') {
                    await navigator.clipboard.writeText(videoUrl);
                    alert('Enlace copiado al portapapeles');
                }
                
                shareModal.classList.remove('show');
            });
        });
        
        downloadButton.addEventListener('click', async (e) => {
            e.stopPropagation();
            optionsMenuContainer.classList.remove('active');
            const currentVideoData = loadedVideoElements[currentVideoIndex]?.videoData;
            if (!currentVideoData || !currentVideoData.videoUrl) {
                alert('No se pudo encontrar la URL del video para descargar.');
                return;
            }
            downloadOverlay.classList.add('active');
            downloadStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparando descarga...';
            try {
                const response = await fetch(currentVideoData.videoUrl);
                if (!response.ok) throw new Error('No se pudo conectar con el servidor del video.');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                const filename = `${currentVideoData.user.substring(1)}_${currentVideoData.music.replace(/[^a-z0-9]/gi, '_')}.mp4`;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                downloadStatus.innerHTML = '<i class="fas fa-check-circle"></i> ¡Descargado!';
                setTimeout(() => downloadOverlay.classList.remove('active'), 1500);
            } catch (error) {
                console.error('Error al descargar el video:', error);
                downloadStatus.innerHTML = '<i class="fas fa-times-circle"></i> Error al descargar';
                setTimeout(() => downloadOverlay.classList.remove('active'), 2500);
            }
        });
        
        // Funcionalidad de reportar video
        reportVideoButton.addEventListener('click', async (e) => {
            e.stopPropagation();
            optionsMenuContainer.classList.remove('active');
            
            if (!loggedInUser) {
                alert('Debes iniciar sesión para reportar videos.');
                window.location.href = 'index.html';
                return;
            }
            
            const currentVideoData = loadedVideoElements[currentVideoIndex]?.videoData;
            if (!currentVideoData) {
                alert('Error al obtener información del video.');
                return;
            }
            
            // Verificar si es su propio video
            const videoUsername = currentVideoData.user ? currentVideoData.user.replace('@', '') : '';
            if (loggedInUser.username === videoUsername) {
                alert('No puedes reportar tus propios videos.');
                return;
            }
            
            document.getElementById('report-video-username').textContent = currentVideoData.user || 'Usuario desconocido';
            reportVideoModal.classList.add('show');
            document.getElementById('report-video-reason').value = '';
            document.getElementById('report-video-description').value = '';
        });
        
        cancelReportVideoBtn.addEventListener('click', () => {
            reportVideoModal.classList.remove('show');
        });
        
        submitReportVideoBtn.addEventListener('click', async () => {
            const reason = document.getElementById('report-video-reason').value;
            const description = document.getElementById('report-video-description').value.trim();
            const currentVideoData = loadedVideoElements[currentVideoIndex]?.videoData;
            
            if (!reason) {
                alert('Por favor, selecciona un motivo para el reporte.');
                return;
            }
            
            if (!currentVideoData || !currentVideoData.videoId) {
                alert('Error al obtener información del video.');
                return;
            }
            
            submitReportVideoBtn.disabled = true;
            submitReportVideoBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
            
            try {
                // Validar que tenemos el username del usuario que reporta
                if (!loggedInUser || !loggedInUser.username) {
                    throw new Error('No se pudo obtener tu información de usuario. Por favor, inicia sesión nuevamente.');
                }
                
                const reportData = {
                    tipo_reporte: 'video',
                    id_video_reportado: currentVideoData.videoId,
                    username_reporter: loggedInUser.username,
                    motivo: reason,
                    descripcion: description || null
                };
                
                // Usar la URL base de config.js
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const RENDER_BACKEND_URL = 'https://likering-backend.onrender.com';
                const LOCAL_BACKEND_URL = 'http://localhost:3000';
                const BASE_URL = isLocalhost ? LOCAL_BACKEND_URL : RENDER_BACKEND_URL;
                const reportUrl = `${BASE_URL}/api/public/reports`;
                
                const response = await fetch(reportUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(reportData)
                });
                
                // Validar que la respuesta sea OK antes de parsear JSON
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error del servidor (${response.status}): ${errorText || 'Error desconocido'}`);
                }
                
                // Validar que la respuesta tenga contenido antes de parsear
                const text = await response.text();
                if (!text) {
                    throw new Error('El servidor no devolvió ninguna respuesta');
                }
                
                let result;
                try {
                    result = JSON.parse(text);
                } catch (parseError) {
                    console.error('Error al parsear respuesta:', parseError);
                    console.error('Respuesta recibida:', text);
                    throw new Error('El servidor devolvió una respuesta inválida');
                }
                
                if (result.success) {
                    alert('¡Reporte enviado correctamente! Los administradores lo revisarán pronto.');
                    reportVideoModal.classList.remove('show');
                    document.getElementById('report-video-reason').value = '';
                    document.getElementById('report-video-description').value = '';
                } else {
                    throw new Error(result.error || 'Error al enviar el reporte');
                }
            } catch (error) {
                console.error('Error al enviar reporte:', error);
                alert('Error al enviar el reporte: ' + error.message);
            } finally {
                submitReportVideoBtn.disabled = false;
                submitReportVideoBtn.innerHTML = 'Enviar';
            }
        });
        
        // Cerrar modal al hacer clic fuera
        reportVideoModal.addEventListener('click', (e) => {
            if (e.target === reportVideoModal) {
                reportVideoModal.classList.remove('show');
            }
        });

    document.getElementById('logout-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        e.preventDefault();
        
        const confirmLogout = confirm('¿Estás seguro de que quieres cerrar sesión?');
        if (confirmLogout) {
            localStorage.removeItem('loggedInUser');
            localStorage.removeItem('userVideos');
            localStorage.removeItem('userPreferences');
            window.location.href = 'index.html';
        }
        
        profileMenuContainer.classList.remove('active');
    });

        
        initialize();
        
        // Recargar estado de seguimiento cuando se vuelve a la página
        // También usar 'pageshow' para detectar cuando se vuelve desde el cache del navegador
        window.addEventListener('focus', async () => {
            console.log('[DEBUG] Window focused. Re-fetching video metadata and updating follow status.');
            await refreshFollowStatus();
        });
        
        window.addEventListener('pageshow', async (event) => {
            // event.persisted es true si la página se cargó desde el cache
            if (event.persisted) {
                console.log('[DEBUG] Page loaded from cache. Re-fetching video metadata.');
                await refreshFollowStatus();
            }
        });
        
        async function refreshFollowStatus() {
            loggedInUser = JSON.parse(localStorage.getItem('loggedInUser')); // Recargar por si cambió
            if (loggedInUser) {
                const updatedVideos = await fetchAllVideoMetadata();
                if (updatedVideos.length > 0) {
                    // Actualizar allVideosMasterList con los datos más recientes
                    allVideosMasterList = updatedVideos;

                    // Recorrer los videos actualmente cargados en el DOM y actualizar su estado
                    loadedVideoElements.forEach(wrapper => {
                        const videoData = wrapper.videoData;
                        const updatedData = updatedVideos.find(v => v.videoId === videoData.videoId);
                        if (updatedData) {
                            // Normalizar nombres de usuario para comparación
                            const videoUsername = videoData.user ? videoData.user.replace('@', '') : '';
                            const loggedInUsername = loggedInUser ? loggedInUser.username : '';
                            const isMyVideo = loggedInUser && videoUsername === loggedInUsername;
                            
                            // Verificar backend PRIMERO (fuente de verdad), luego localStorage para follows
                            const isFollowingFromBackend = updatedData.isFollowingUser;
                            const isFollowingInStorage = isUserFollowed(videoUsername);
                            
                            // Priorizar backend sobre localStorage (backend es fuente de verdad)
                            const isAlreadyFollowing = isFollowingFromBackend || isFollowingInStorage;
                            
                            // Sincronizar localStorage con backend
                            if (isFollowingFromBackend && !isFollowingInStorage) {
                                saveFollowedUser(videoUsername);
                            } else if (!isFollowingFromBackend && isFollowingInStorage) {
                                // Si el backend dice que no se sigue pero localStorage dice que sí, usar backend
                                removeFollowedUser(videoUsername);
                            }
                            
                            // Actualizar el estado de seguimiento
                            videoData.isFollowingUser = isAlreadyFollowing;
                            
                            // Verificar backend PRIMERO (fuente de verdad), luego localStorage
                            const isLikedFromBackend = updatedData.isLikedByCurrentUser;
                            const isLikedInStorage = isVideoLiked(videoData.videoId);
                            const isLiked = isLikedFromBackend || isLikedInStorage;
                            
                            // Sincronizar localStorage con el backend
                            if (isLikedFromBackend && !isLikedInStorage) {
                                saveLikedVideo(videoData.videoId);
                            }
                            
                            // Actualizar el estado de likes
                            videoData.isLikedByCurrentUser = isLiked;
                            
                            // Actualizar el corazón visualmente
                            const likeArea = wrapper.querySelector('.interaction-area');
                            if (likeArea) {
                                const iconDiv = likeArea.querySelector('.icon');
                                if (iconDiv) {
                                    if (isLiked) {
                                        iconDiv.classList.add('liked');
                                        if (!isLikedInStorage) {
                                            saveLikedVideo(videoData.videoId);
                                        }
                                    } else {
                                        iconDiv.classList.remove('liked');
                                    }
                                }
                            }
                            
                            const profileContainer = wrapper.querySelector('.profile-picture-container');
                            let followBtn = wrapper.videoData.followButtonElement || wrapper.querySelector('.follow-button');

                            if (isMyVideo || isAlreadyFollowing) {
                                // Si ahora se sigue o es su propio video, ELIMINAR el botón completamente
                                if (followBtn) {
                                    followBtn.remove();
                                    videoData.followButtonElement = null;
                                    videoData.isFollowingUser = true; // Asegurar que esté en true
                                    // Asegurar que también esté en localStorage
                                    if (!isFollowingInStorage) {
                                        saveFollowedUser(videoUsername);
                                    }
                                    console.log(`[DEBUG] Botón de seguir para @${videoUsername} eliminado al volver a la página.`);
                                }
                            } else {
                                // Si no se sigue y no es su propio video, asegurar que el botón exista
                                if (!followBtn && !isMyVideo) {
                                    console.log(`[DEBUG] @${videoUsername} no seguido, recreando botón.`);
                                    const newFollowButton = document.createElement('div');
                                    newFollowButton.className = 'follow-button';
                                    newFollowButton.textContent = '+';
                                    newFollowButton.dataset.targetUser = videoUsername;
                                    newFollowButton.addEventListener('click', (e) => {
                                        e.stopPropagation();
                                        e.preventDefault();
                                        if (!loggedInUser) {
                                            alert("Debes iniciar sesión para seguir canales.");
                                            return;
                                        }
                                        showFollowConfirmModal(videoUsername);
                                    });
                                    if (profileContainer) {
                                        profileContainer.append(newFollowButton);
                                        videoData.followButtonElement = newFollowButton;
                                    }
                                }
                            }
                        }
                    });
                    // También actualizar videosToPlayQueue para futuros videos
                    videosToPlayQueue = videosToPlayQueue.map(video => {
                        const updatedData = updatedVideos.find(v => v.videoId === video.videoId);
                        if (updatedData) {
                            const videoUsername = video.user ? video.user.replace('@', '') : '';
                            const isFollowingFromBackend = updatedData.isFollowingUser;
                            const isFollowingInStorage = isUserFollowed(videoUsername);
                            
                            // Priorizar backend sobre localStorage (backend es fuente de verdad)
                            updatedData.isFollowingUser = isFollowingFromBackend || isFollowingInStorage;
                            
                            // Sincronizar localStorage con backend
                            if (isFollowingFromBackend && !isFollowingInStorage) {
                                saveFollowedUser(videoUsername);
                            } else if (!isFollowingFromBackend && isFollowingInStorage) {
                                // Si el backend dice que no se sigue pero localStorage dice que sí, usar backend
                                removeFollowedUser(videoUsername);
                            }
                            
                            // Actualizar likes también - priorizar backend
                            const isLikedFromBackend = updatedData.isLikedByCurrentUser;
                            const isLikedInStorage = isVideoLiked(video.videoId);
                            updatedData.isLikedByCurrentUser = isLikedFromBackend || isLikedInStorage;
                            
                            // Sincronizar localStorage con el backend
                            if (isLikedFromBackend && !isLikedInStorage) {
                                saveLikedVideo(video.videoId);
                            }
                        }
                        return updatedData || video;
                    });
                }
            }
        }
    });

</script>
</body>
</html>